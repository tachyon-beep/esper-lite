name: Test Suite

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      # Use pre-built ruff action - no installation needed
      - name: Lint with ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: "check src/ tests/"

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      # Install only what mypy needs (stubs + minimal deps)
      - name: Install dependencies for type checking
        run: |
          uv pip install --system mypy types-PyYAML
          uv pip install --system -e . --no-deps
          uv pip install --system torch --index-url https://download.pytorch.org/whl/cpu

      - name: Type check with mypy
        run: MYPYPATH=src mypy -p esper

  property-tests:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run property tests
        env:
          HYPOTHESIS_PROFILE: ci
        run: |
          uv run pytest tests/properties/ \
            -v \
            --hypothesis-show-statistics \
            --tb=short

  unit-and-integration-tests:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run unit tests
        run: |
          uv run pytest tests/unit/ -v --cov=src --cov-report=json

      - name: Check coverage threshold
        run: |
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% below 80% threshold"
            exit 1
          fi

      - name: Run integration tests
        run: |
          uv run pytest tests/integration/ -v

  e2e-smoke-tests:
    runs-on: ubuntu-latest
    needs: [property-tests, unit-and-integration-tests]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run E2E smoke tests
        run: |
          uv run pytest tests/e2e/ -v -m "not slow"

  nightly-full-suite:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run full property tests (thorough)
        env:
          HYPOTHESIS_PROFILE: thorough
        run: |
          uv run pytest tests/properties/ -v --hypothesis-show-statistics

      - name: Run all E2E tests
        run: |
          uv run pytest tests/e2e/ -v  # All tests, including slow ones

      - name: Run performance benchmarks
        run: |
          uv run pytest tests/benchmarks/ -v
