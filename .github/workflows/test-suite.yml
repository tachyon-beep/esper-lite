name: Test Suite

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ruff mypy
          pip install -e .

      - name: Lint with ruff
        run: ruff check src/ tests/

      - name: Type check with mypy
        run: MYPYPATH=src mypy -p esper

  property-tests:
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}

      - name: Install dependencies
        run: |
          pip install -e .[dev]
          pip install hypothesis pytest

      - name: Run property tests
        env:
          HYPOTHESIS_PROFILE: ci
        run: |
          pytest tests/properties/ \
            -v \
            --hypothesis-show-statistics \
            --tb=short

  unit-and-integration-tests:
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}

      - name: Install dependencies
        run: |
          pip install -e .[dev]
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=json

      - name: Check coverage threshold
        run: |
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% below 80% threshold"
            exit 1
          fi

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v

  e2e-smoke-tests:
    runs-on: ubuntu-latest
    needs: [property-tests, unit-and-integration-tests]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .[dev]
          pip install pytest

      - name: Run E2E smoke tests
        run: |
          pytest tests/e2e/ -v -m "not slow"

  nightly-full-suite:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .[dev]
          pip install hypothesis pytest

      - name: Run full property tests (thorough)
        env:
          HYPOTHESIS_PROFILE: thorough
        run: |
          pytest tests/properties/ -v --hypothesis-show-statistics

      - name: Run all E2E tests
        run: |
          pytest tests/e2e/ -v  # All tests, including slow ones

      - name: Run performance benchmarks
        run: |
          pytest tests/benchmarks/ -v
