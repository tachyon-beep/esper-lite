# ENH-029 Closeout: TamiyoBrain A/B Testing Polish

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Close out the remaining 6 polish items from ENH-029 to complete TamiyoBrain A/B testing support.

**Architecture:** These are independent polish tasks that can be done in any order. Each task is self-contained with its own tests. TDD approach for all changes.

**Tech Stack:** Python 3.13, pytest, Textual TUI, Rich, TCSS

---

## Task 1: Filter "default" group_id in Aggregator

Prevent `[default]` label from appearing in single-policy training mode.

**Files:**
- Modify: `src/esper/karn/sanctum/aggregator.py:536-539`
- Test: `tests/karn/sanctum/test_aggregator.py`

**Step 1.1: Write failing test**

Add to `tests/karn/sanctum/test_aggregator.py`:

```python
def test_ppo_update_filters_default_group_id():
    """group_id='default' should NOT set tamiyo.group_id (single-policy mode)."""
    agg = SanctumAggregator(num_envs=4)

    event = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id="default",  # This is the default for single-policy
    )
    agg.process_event(event)

    snapshot = agg.get_snapshot()
    # Should NOT be set to "default" - that would show [default] label
    assert snapshot.tamiyo.group_id is None
```

**Step 1.2: Run test to verify it fails**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_aggregator.py::test_ppo_update_filters_default_group_id -v
```

Expected: FAIL - `AssertionError: assert 'default' is None`

**Step 1.3: Implement the fix**

In `src/esper/karn/sanctum/aggregator.py`, change lines 536-539 from:

```python
        # A/B testing group identification
        group_id = event.group_id
        if group_id:
            self._tamiyo.group_id = group_id
```

To:

```python
        # A/B testing group identification
        # Filter out "default" - that's the single-policy default value
        group_id = event.group_id
        if group_id and group_id != "default":
            self._tamiyo.group_id = group_id
```

**Step 1.4: Run test to verify it passes**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_aggregator.py::test_ppo_update_filters_default_group_id -v
```

Expected: PASS

**Step 1.5: Commit**

```bash
git add src/esper/karn/sanctum/aggregator.py tests/karn/sanctum/test_aggregator.py
git commit -m "fix(sanctum): filter 'default' group_id in aggregator

Prevents [default] label appearing in single-policy training mode.
ENH-029 item 1."
```

---

## Task 2: Add Edge Case Tests for group_id

Add comprehensive test coverage for group_id edge cases.

**Files:**
- Test: `tests/karn/sanctum/test_aggregator.py`
- Test: `tests/karn/sanctum/test_tamiyo_brain.py`

**Step 2.1: Add aggregator edge case tests**

Add to `tests/karn/sanctum/test_aggregator.py`:

```python
def test_ppo_update_with_none_group_id():
    """group_id=None should leave tamiyo.group_id as None."""
    agg = SanctumAggregator(num_envs=4)

    event = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id=None,
    )
    agg.process_event(event)

    snapshot = agg.get_snapshot()
    assert snapshot.tamiyo.group_id is None


def test_ppo_update_group_id_transition():
    """Group ID change (A→B) should update tamiyo.group_id."""
    agg = SanctumAggregator(num_envs=4)

    # First event with group A
    event_a = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id="A",
    )
    agg.process_event(event_a)
    assert agg.get_snapshot().tamiyo.group_id == "A"

    # Second event with group B
    event_b = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id="B",
    )
    agg.process_event(event_b)
    assert agg.get_snapshot().tamiyo.group_id == "B"


def test_ppo_update_group_c():
    """Group C should be accepted (not just A and B)."""
    agg = SanctumAggregator(num_envs=4)

    event = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id="C",
    )
    agg.process_event(event)

    snapshot = agg.get_snapshot()
    assert snapshot.tamiyo.group_id == "C"


def test_ppo_update_unknown_group_id():
    """Unknown group_id (e.g., 'D') should be accepted."""
    agg = SanctumAggregator(num_envs=4)

    event = TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        data={"policy_loss": 0.1},
        group_id="experiment_42",  # Arbitrary identifier
    )
    agg.process_event(event)

    snapshot = agg.get_snapshot()
    assert snapshot.tamiyo.group_id == "experiment_42"
```

**Step 2.2: Run aggregator tests**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_aggregator.py -k "group" -v
```

Expected: All PASS

**Step 2.3: Add TamiyoBrain group_id edge case tests**

Add to `tests/karn/sanctum/test_tamiyo_brain.py`:

```python
@pytest.mark.asyncio
async def test_group_c_has_magenta_border():
    """Group C should use magenta border color."""
    from textual.app import App, ComposeResult
    from esper.karn.sanctum.widgets.tamiyo_brain import TamiyoBrain
    from esper.karn.sanctum.schema import SanctumSnapshot, TamiyoState

    class TestApp(App):
        CSS = """
        TamiyoBrain.group-c { border: solid magenta; }
        """
        def compose(self) -> ComposeResult:
            yield TamiyoBrain(id="tamiyo")

    app = TestApp()
    async with app.run_test():
        widget = app.query_one("#tamiyo", TamiyoBrain)
        snapshot = SanctumSnapshot()
        snapshot.tamiyo = TamiyoState(group_id="C", ppo_data_received=True)
        widget.update_snapshot(snapshot)

        assert widget.has_class("group-c")


@pytest.mark.asyncio
async def test_unknown_group_shows_fallback_label():
    """Unknown group_id should show [D] format in banner."""
    from io import StringIO
    from rich.console import Console
    from esper.karn.sanctum.widgets.tamiyo_brain import TamiyoBrain
    from esper.karn.sanctum.schema import SanctumSnapshot, TamiyoState

    widget = TamiyoBrain()
    snapshot = SanctumSnapshot()
    snapshot.tamiyo = TamiyoState(group_id="D", ppo_data_received=True)
    widget._snapshot = snapshot

    banner = widget._render_status_banner()
    console = Console(file=StringIO(), width=120, force_terminal=True)
    console.print(banner)
    output = console.file.getvalue()

    # Should show [D] fallback format
    assert "[D]" in output


@pytest.mark.asyncio
async def test_no_group_label_when_none():
    """No group label should appear when group_id is None."""
    from io import StringIO
    from rich.console import Console
    from esper.karn.sanctum.widgets.tamiyo_brain import TamiyoBrain
    from esper.karn.sanctum.schema import SanctumSnapshot, TamiyoState

    widget = TamiyoBrain()
    snapshot = SanctumSnapshot()
    snapshot.tamiyo = TamiyoState(group_id=None, ppo_data_received=True)
    widget._snapshot = snapshot

    banner = widget._render_status_banner()
    console = Console(file=StringIO(), width=120, force_terminal=True)
    console.print(banner)
    output = console.file.getvalue()

    # Should NOT contain group labels or separator before status
    assert "Policy A" not in output
    assert "Policy B" not in output
    assert "Policy C" not in output
```

**Step 2.4: Run TamiyoBrain tests**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_tamiyo_brain.py -k "group" -v
```

Expected: All PASS

**Step 2.5: Commit**

```bash
git add tests/karn/sanctum/test_aggregator.py tests/karn/sanctum/test_tamiyo_brain.py
git commit -m "test(sanctum): add edge case tests for group_id handling

Cover: None, 'default', A→B transition, group C, unknown 'D'.
ENH-029 item 2."
```

---

## Task 3: Upstream Telemetry Gap - Add group_id to emit_ppo_update_event

Add `group_id` parameter to the emitter so A/B testing works end-to-end.

**Files:**
- Modify: `src/esper/simic/telemetry/emitters.py:629-709`
- Test: `tests/simic/telemetry/test_emitters.py` (if exists) or inline verification

**Step 3.1: Write failing test**

First check if test file exists, then add test:

```python
# In tests/simic/telemetry/test_emitters.py (create if needed)
def test_emit_ppo_update_event_propagates_group_id():
    """emit_ppo_update_event should propagate group_id to TelemetryEvent."""
    from unittest.mock import MagicMock
    from esper.simic.telemetry.emitters import emit_ppo_update_event

    hub = MagicMock()

    emit_ppo_update_event(
        hub=hub,
        metrics={"policy_loss": 0.1, "value_loss": 0.2, "entropy": 1.5},
        episodes_completed=10,
        batch_idx=5,
        epoch=100,
        optimizer=None,
        grad_norm=1.0,
        update_time_ms=50.0,
        group_id="B",  # New parameter
    )

    # Verify hub.emit was called
    hub.emit.assert_called_once()
    event = hub.emit.call_args[0][0]

    # Verify group_id was propagated
    assert event.group_id == "B"
```

**Step 3.2: Run test to verify it fails**

```bash
PYTHONPATH=src uv run pytest tests/simic/telemetry/test_emitters.py::test_emit_ppo_update_event_propagates_group_id -v
```

Expected: FAIL - `TypeError: emit_ppo_update_event() got an unexpected keyword argument 'group_id'`

**Step 3.3: Add group_id parameter to emit_ppo_update_event**

In `src/esper/simic/telemetry/emitters.py`, modify the function signature (around line 629):

From:
```python
def emit_ppo_update_event(
    *,
    hub,
    metrics: dict,
    episodes_completed: int,
    batch_idx: int,
    epoch: int,
    optimizer,
    grad_norm: float | None,
    update_time_ms: float | None,
) -> None:
```

To:
```python
def emit_ppo_update_event(
    *,
    hub,
    metrics: dict,
    episodes_completed: int,
    batch_idx: int,
    epoch: int,
    optimizer,
    grad_norm: float | None,
    update_time_ms: float | None,
    group_id: str = "default",  # A/B testing identifier
) -> None:
```

And modify the hub.emit call (around line 705):

From:
```python
    hub.emit(TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        epoch=episodes_completed,  # Monotonic per-batch epoch id (NOT inner epoch!)
        data=data,
    ))
```

To:
```python
    hub.emit(TelemetryEvent(
        event_type=TelemetryEventType.PPO_UPDATE_COMPLETED,
        epoch=episodes_completed,  # Monotonic per-batch epoch id (NOT inner epoch!)
        data=data,
        group_id=group_id,
    ))
```

**Step 3.4: Run test to verify it passes**

```bash
PYTHONPATH=src uv run pytest tests/simic/telemetry/test_emitters.py::test_emit_ppo_update_event_propagates_group_id -v
```

Expected: PASS

**Step 3.5: Commit**

```bash
git add src/esper/simic/telemetry/emitters.py tests/simic/telemetry/test_emitters.py
git commit -m "feat(telemetry): add group_id parameter to emit_ppo_update_event

Enables A/B testing by propagating group_id to TelemetryEvent.
ENH-029 item 3."
```

---

## Task 4: Add group_id to border_title for Accessibility

Update TamiyoBrain's `border_title` to include group identifier for screen readers.

**Files:**
- Modify: `src/esper/karn/sanctum/widgets/tamiyo_brain.py:101-104`
- Test: `tests/karn/sanctum/test_tamiyo_brain.py`

**Step 4.1: Write failing test**

Add to `tests/karn/sanctum/test_tamiyo_brain.py`:

```python
@pytest.mark.asyncio
async def test_border_title_includes_group_id():
    """border_title should include group_id for accessibility."""
    from textual.app import App, ComposeResult
    from esper.karn.sanctum.widgets.tamiyo_brain import TamiyoBrain
    from esper.karn.sanctum.schema import SanctumSnapshot, TamiyoState

    class TestApp(App):
        def compose(self) -> ComposeResult:
            yield TamiyoBrain(id="tamiyo")

    app = TestApp()
    async with app.run_test():
        widget = app.query_one("#tamiyo", TamiyoBrain)

        # Without group_id
        snapshot_single = SanctumSnapshot()
        snapshot_single.tamiyo = TamiyoState(group_id=None, ppo_data_received=True)
        widget.update_snapshot(snapshot_single)
        assert widget.border_title == "TAMIYO"

        # With group_id
        snapshot_ab = SanctumSnapshot()
        snapshot_ab.tamiyo = TamiyoState(group_id="A", ppo_data_received=True)
        widget.update_snapshot(snapshot_ab)
        assert widget.border_title == "TAMIYO [A]"
```

**Step 4.2: Run test to verify it fails**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_tamiyo_brain.py::test_border_title_includes_group_id -v
```

Expected: FAIL - `AssertionError: assert 'TAMIYO' == 'TAMIYO [A]'`

**Step 4.3: Implement the fix**

In `src/esper/karn/sanctum/widgets/tamiyo_brain.py`, modify the `update_snapshot` method (around line 101):

From:
```python
    def update_snapshot(self, snapshot: "SanctumSnapshot") -> None:
        self._snapshot = snapshot
        self._update_status_class()
        self.refresh()
```

To:
```python
    def update_snapshot(self, snapshot: "SanctumSnapshot") -> None:
        self._snapshot = snapshot
        self._update_status_class()
        # Update border_title for accessibility (screen readers, colorblind users)
        if snapshot.tamiyo.group_id:
            self.border_title = f"TAMIYO [{snapshot.tamiyo.group_id}]"
        else:
            self.border_title = "TAMIYO"
        self.refresh()
```

**Step 4.4: Run test to verify it passes**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_tamiyo_brain.py::test_border_title_includes_group_id -v
```

Expected: PASS

**Step 4.5: Commit**

```bash
git add src/esper/karn/sanctum/widgets/tamiyo_brain.py tests/karn/sanctum/test_tamiyo_brain.py
git commit -m "feat(sanctum): add group_id to TamiyoBrain border_title

Improves accessibility for screen readers and colorblind users.
ENH-029 item 4."
```

---

## Task 5: Strengthen CSS Separator for Group Label

Use double pipe `││` or wider spacing for better visual separation.

**Files:**
- Modify: `src/esper/karn/sanctum/widgets/tamiyo_brain.py:530-531`

**Step 5.1: Modify the separator**

In `src/esper/karn/sanctum/widgets/tamiyo_brain.py`, change line 531:

From:
```python
            banner.append("│ ", style="dim")
```

To:
```python
            banner.append(" ┃ ", style="dim")  # Heavy vertical bar with spacing
```

**Step 5.2: Verify visually and run tests**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/test_tamiyo_brain.py -v
```

Expected: All PASS (separator is visual, tests check content not exact formatting)

**Step 5.3: Commit**

```bash
git add src/esper/karn/sanctum/widgets/tamiyo_brain.py
git commit -m "style(sanctum): strengthen group label separator in status banner

Use heavy vertical bar (┃) with spacing for better visual separation.
ENH-029 item 5."
```

---

## Task 6: CSS Focus State Duplication Cleanup

Remove duplicate focus styling - keep only Textual's `:focus` pseudo-class.

**Files:**
- Modify: `src/esper/karn/sanctum/styles.tcss:136-138`
- Modify: `src/esper/karn/sanctum/widgets/tamiyo_brain.py:93-99`

**Step 6.1: Remove `.focused` class from CSS**

In `src/esper/karn/sanctum/styles.tcss`, delete lines 136-138:

```tcss
TamiyoBrain.focused {
    border: double $accent;
}
```

**Step 6.2: Remove manual focus handling from TamiyoBrain**

In `src/esper/karn/sanctum/widgets/tamiyo_brain.py`, delete the `on_focus` and `on_blur` methods (lines 93-99):

```python
    def on_focus(self) -> None:
        """Handle focus - highlight border."""
        self.add_class("focused")

    def on_blur(self) -> None:
        """Handle blur - remove highlight."""
        self.remove_class("focused")
```

**Step 6.3: Run tests to verify focus still works**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/ -v
```

Expected: All PASS (Textual handles `:focus` automatically)

**Step 6.4: Commit**

```bash
git add src/esper/karn/sanctum/styles.tcss src/esper/karn/sanctum/widgets/tamiyo_brain.py
git commit -m "refactor(sanctum): remove duplicate focus state handling

Keep Textual's :focus pseudo-class, remove manual .focused class.
ENH-029 item 6."
```

---

## Task 7: Final Verification and ENH-029 Closure

Run full test suite and close out the enhancement ticket.

**Step 7.1: Run full Sanctum test suite**

```bash
PYTHONPATH=src uv run pytest tests/karn/sanctum/ -v
```

Expected: All PASS

**Step 7.2: Update ENH-029 status**

In `docs/bugs/ENH-029-P3-sanctum-tamiyo-brain-polish.md`, change:
- Status from `Open` to `Closed`
- Add resolution date

**Step 7.3: Final commit**

```bash
git add docs/bugs/ENH-029-P3-sanctum-tamiyo-brain-polish.md
git commit -m "docs: close ENH-029 TamiyoBrain A/B Testing Polish

All 7 items resolved:
1. Filter 'default' group_id
2. Edge case tests
3. Upstream telemetry gap
4. border_title accessibility
5. CSS separator
6. Focus state cleanup
7. Layout height (resolved via ComparisonHeader consolidation)"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Filter "default" group_id | aggregator.py |
| 2 | Edge case tests | test_aggregator.py, test_tamiyo_brain.py |
| 3 | Upstream telemetry gap | emitters.py |
| 4 | border_title accessibility | tamiyo_brain.py |
| 5 | CSS separator | tamiyo_brain.py |
| 6 | Focus state cleanup | styles.tcss, tamiyo_brain.py |
| 7 | Final verification | ENH-029 doc |

**Estimated time:** 30-45 minutes total (5-7 minutes per task)
