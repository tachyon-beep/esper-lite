# Tolaria — Delta Matrix

Status and evidence per requirement. See rubric in `../rubric.md`.

| Area | Design Source | Expected Behaviour | Prototype Evidence | Status | Severity | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| Epoch lifecycle & budget | `01.1-tolaria-epoch-lifecycle.md` | End‑of‑epoch work ≤18 ms; enforce guard and conservative mode on breach | `src/esper/tolaria/trainer.py` (budget knobs + breaker + conservative fallback) | Implemented | Must‑have | Budgets enforced with breaker + telemetry escalation; conservative mode entered automatically. |
| Tamiyo handshake | `01.1`, `01.4` | Build `SystemStatePacket`, invoke Tamiyo with timeout (≈2 s), process `AdaptationCommand` | `trainer.run()` wraps Tamiyo/Kasmina calls with timeouts and conservative fallback | Implemented | Should‑have | Timeouts convert to conservative commands; security/HMAC handled upstream. |
| Kasmina integration | `01.4` | Apply adaptation commands using Leyline contracts | `trainer.run()` calls `KasminaClient.apply_command` | Implemented | Should‑have | Minimal application path with timeout + warning events; no escalation/broadcast. |
| Multi‑seed gradient aggregation | `01.1` | Aggregate host/seed losses with state‑aware weighting; stabilise; reduce conflicts | `src/esper/tolaria/aggregation.py`, `trainer.py` (registry masks + attribution), `tests/tolaria/test_aggregation_attribution.py` | Implemented | Must‑have | Seed-aware aggregation using Kasmina’s `SeedParameterRegistry` masks; teacher gradients split by attribution weights (dataloader or Kasmina.attribute_batch); PCGrad optional; per‑seed telemetry (weight/norm/share/conflicts/alpha/mask). |
| Unified LR controller | `01.3` | Central LR authority; schedules with warmup; telemetry of current LR | `src/esper/tolaria/lr_controller.py`, `trainer.py` wiring | Implemented | Must‑have | Policies: constant/cosine/step with optional warmup; metrics `tolaria.lr_controller.*`. |
| Dynamic optimiser manager | `01.3` | Safe rebuilds with breaker; preserve state when compatible | `src/esper/tolaria/optimizer_manager.py`, `trainer.py` wiring | Implemented | Should‑have | Rebuild fence via settings; metrics for rebuilds/failures/skips/latency. |
| Checkpoint + WAL semantics | `01.2` | Atomic persistence with O_DSYNC; metadata consistency | `trainer._checkpoint()` saves torch state + `wal.json` | Implemented | Should‑have | Atomic writes via tmp+rename, directory fsync, O_DSYNC when available, and CRC32 verification; last‑checkpoint semantics only. |
| Two‑tier rollback | `01.2` | 500 ms fast rollback (LRU cache); 12 s full | `src/esper/tolaria/rollback.py`, `trainer.py`, `src/esper/weatherlight/service_runner.py` | Implemented | Must‑have | Fast cache + WAL restore with shared-memory deadline signal bridged into Weatherlight telemetry and Oona emergency stream. |
| Emergency protocol | `01.2` | Four‑level escalation; broadcast; halts | `src/esper/tolaria/emergency.py`, `trainer.py`, `src/esper/weatherlight/service_runner.py`, `src/esper/oona/messaging.py` | Implemented | Must‑have | EmergencySignal Leyline contract, shared-memory bridge, and Oona emergency fast path deliver sub-100 ms broadcast and Weatherlight telemetry. |
| Circuit breakers & conservative mode | `01.1` | Breakers around timing/integrity; degrade features | `TolariaTrainer` breaker + conservative mode events | Implemented | Must‑have | Breaker tracks failures; conservative mode emits telemetry + priority hint. |
| Telemetry & Oona | `01.1`, `01.4` | Structured metrics/events; publish to Oona | `build_telemetry_packet`, `publish_history()` | Implemented | Should‑have | Priority hint in packets; Weatherlight routes HIGH/CRITICAL to emergency stream. |
| Leyline as canonical | `01.4` | Use Leyline data classes/enums without local mappings | `leyline_pb2.SystemStatePacket`, `AdaptationCommand` | Implemented | Must‑have | Contracts respected in prototype. |
| Performance profiling | `01.1` | Capture timings; optional Chrome trace | `src/esper/tolaria/profiler.py` hooks; `scripts/profile_tolaria.py` | Partially Implemented | Nice‑to‑have | Epoch‑scope traces via env; external harness available. |

| PyTorch 2.8 upgrades | `01.1` | torch.compile guarded; AMP + GradScaler; TF32; pinned‑memory/non‑blocking; foreach SGD | `src/esper/tolaria/trainer.py`, `pytorch-2.8-upgrades.md` | Implemented | Must‑have | Runtime fallback events on compile failures; CPU paths eager.
