# Finding Ticket: EMA Count Tracking Semantics Confusing

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B5-PT-01` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 5 |
| **Agent** | `pytorch` |
| **Domain** | `simic/control` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/control/normalization.py` |
| **Line(s)** | `106-107` |
| **Function/Class** | `RunningMeanStd.update()` (EMA path) |

---

## Summary

**One-line summary:** In EMA mode, `count` is incremented but not used, creating confusing semantics.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

In EMA mode, `count` is still incremented by `batch_count` but the comment notes "count is not used in EMA":

```python
# EMA update path
self.count = self.count + batch_count  # Still increments
# But count doesn't affect the EMA formula...
```

This creates confusion:
- The count tracks total samples seen
- But it doesn't reflect the "effective sample size" of the EMA estimator
- Users might expect count to mean something in EMA mode

---

## Recommended Fix

Either:

1. **Don't increment count in EMA mode:**
```python
if self.momentum is None:
    self.count = self.count + batch_count  # Only for Welford
else:
    pass  # EMA doesn't track count
```

2. **Document that count represents "samples seen" not "effective weight":**
```python
# In EMA mode, count tracks total samples seen but does not affect
# the estimator. The effective sample size is approximately
# 1 / (1 - momentum) for a converged EMA.
self.count = self.count + batch_count
```

---

## Verification

### How to Verify the Fix

- [ ] Choose approach and implement
- [ ] Update docstring to clarify count semantics

---

## Related Findings

- B5-DRL-02: EMA variance is biased estimator
- B5-CR-08: EMA delta variable naming

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch5-pytorch.md`
**Section:** "P2 - Performance/Resource Issues" (ID 2)

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** Legitimate API design concern. In RL normalization, count semantics matter for diagnostics (e.g., "how much data has the normalizer seen?"). The EMA effective sample size is approximately 1/(1-momentum), which differs conceptually from raw sample count. I favor Option 2 (documentation) over Option 1 because tracking samples seen is still useful for logging/debugging even if it doesn't affect the EMA formula. The key fix is clarifying that count is "samples observed" not "effective weight."

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `OBJECT` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** The severity is overstated. Reviewing lines 106-107 of `normalization.py`, the comment explicitly states "count is not used in EMA" and the code includes a purposeful increment for diagnostic tracking. This is intentional behavior with in-code documentation - not a bug or API design violation. The recommended fixes would either remove useful diagnostic capability (Option 1) or add redundant documentation (Option 2). Should be downgraded to P4 at most, or closed as "working as intended" since the behavior is already documented in the comment at line 106.

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** Confirmed at lines 106-107: count is incremented in EMA mode but has no effect on the EMA computation. This creates semantic confusion - users may interpret `count` as having weight in the estimator when it does not. Recommend option 2 (document that count is purely diagnostic in EMA mode). Removing the increment entirely (option 1) would break checkpointing symmetry since `state_dict()` includes count. The "effective sample size" comment in option 2 is mathematically accurate (1/(1-m) for converged EMA).
