# Finding Ticket: snapshot() Could Return Captured Key Info

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B1-CR-07` |
| **Severity** | `P4` |
| **Status** | `open` |
| **Batch** | 1 |
| **Agent** | `codereview` |
| **Domain** | `tolaria` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tolaria/governor.py` |
| **Line(s)** | `85-136` |
| **Function/Class** | `TolariaGovernor.snapshot()` |

---

## Summary

**One-line summary:** `snapshot()` returns `None` but could return useful metadata about what was captured.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The `snapshot()` method saves model state but provides no feedback about what was captured. Callers can't easily verify:
- Which keys were captured
- How many bytes were saved
- Whether the snapshot includes seeds or just host

### Code Evidence

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py:85-136

def snapshot(self) -> None:
    """Take a snapshot of the current model state for potential rollback."""
    ...
    self._snapshot = {k: v.cpu() for k, v in state_dict.items() if ...}
    # Returns None - no feedback to caller
```

### Why This Matters

- Debugging is harder - can't easily verify snapshot contents
- Logging requires caller to duplicate key-discovery logic
- Minor API ergonomics issue

---

## Recommended Fix

### Approach

Return a simple dataclass or namedtuple with snapshot metadata.

### Suggested Code Change

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py

@dataclass(frozen=True, slots=True)
class SnapshotInfo:
    """Metadata about a governor snapshot."""
    num_keys: int
    keys: tuple[str, ...]
    excluded_seed_keys: int

def snapshot(self) -> SnapshotInfo:
    """Take a snapshot of the current model state for potential rollback."""
    ...
    self._snapshot = {k: v.cpu() for k, v in state_dict.items() if ...}
    return SnapshotInfo(
        num_keys=len(self._snapshot),
        keys=tuple(self._snapshot.keys()),
        excluded_seed_keys=excluded_count,
    )
```

### Alternative Approaches

1. **Keep None return** - Current behavior is fine, failure raises exception
2. **Return key count only** - `def snapshot(self) -> int`
3. **Emit telemetry instead** - GOVERNOR_SNAPSHOT event with metadata

---

## Verification

### How to Verify the Fix

- [ ] Unit test: Verify return value contains expected keys
- [ ] Update callers: Check if any callers use the return value

### Test Files to Update

- `tests/tolaria/test_governor.py` - update snapshot tests to verify return value

---

## Cross-Review

| Agent | Verdict | Evaluation |
|-------|---------|------------|
| **DRL** | NEUTRAL | Returning snapshot metadata is an API ergonomics improvement that does not affect reward signals, policy updates, or training stability. Option 3 (emit telemetry) would have marginal debugging value but the void return is functionally correct for RL purposes. |
| **PyTorch** | NEUTRAL | Returning metadata from `snapshot()` is a pure API ergonomics concern with no bearing on tensor memory management or compile compatibility. The `.cpu()` copy operation and state dict handling remain unchanged; this is documentation-level feedback. |
| **CodeReview** | OBJECT | Returning `SnapshotInfo` from `snapshot()` adds complexity with limited value; callers don't currently need this metadata. If debugging is needed, telemetry events (Option 3 in ticket) are more appropriate than changing API signatures for observability. |

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch1-codereview.md`
**Section:** "P4-003: snapshot() could benefit from a return value"
