# Finding Ticket: Return Type Could Be More Specific (MorphogeneticModel)

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B1-CR-05` |
| **Severity** | `P4` |
| **Status** | `open` |
| **Batch** | 1 |
| **Agent** | `codereview` |
| **Domain** | `tolaria` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tolaria/environment.py` |
| **Line(s)** | `51` |
| **Function/Class** | `create_model()` |

---

## Summary

**One-line summary:** `create_model()` returns `torch.nn.Module` but always returns `MorphogeneticModel` - type could be more specific.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The function signature declares a generic return type, but the implementation always returns a specific type.

### Code Evidence

```python
# /home/john/esper-lite/src/esper/tolaria/environment.py:51

# Current:
def create_model(
    task_spec: "TaskSpec",
    device: torch.device | str = "cpu",
) -> torch.nn.Module:
    ...
    return model  # Always a MorphogeneticModel
```

### Why This Matters

- IDE autocompletion for callers won't suggest MorphogeneticModel-specific attributes
- Callers must cast or use `assert isinstance()` to access morphogenetic features
- Reduces type safety at call sites

---

## Recommended Fix

### Suggested Code Change

```python
# /home/john/esper-lite/src/esper/tolaria/environment.py

from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from esper.kasmina.host import MorphogeneticModel

def create_model(
    task_spec: "TaskSpec",
    device: torch.device | str = "cpu",
) -> "MorphogeneticModel":
    ...
```

Note: The `TYPE_CHECKING` pattern is already used in this file for `TaskSpec`, so this follows existing conventions.

---

## Verification

### How to Verify the Fix

- [ ] Type check: Run mypy and verify no errors
- [ ] IDE test: Verify autocompletion works for callers

### Test Files to Update

- None needed - type-only change

---

## Cross-Review

| Agent | Verdict | Evaluation |
|-------|---------|------------|
| **DRL** | NEUTRAL | Return type annotation has no runtime effect on RL training, gradient flow, or policy optimization. IDE convenience improvement only; the actual model returned is unchanged and training behavior is unaffected. |
| **PyTorch** | NEUTRAL | Return type annotation precision improves IDE support but has no bearing on torch.compile, JIT tracing, or runtime behavior. MorphogeneticModel is still an nn.Module subclass; the generated code and memory layout are identical regardless of declared type. |
| **CodeReview** | OBJECT | The generic `torch.nn.Module` return type is intentional API design - it keeps `tolaria/environment.py` decoupled from `kasmina/host.py`. Changing to `MorphogeneticModel` would introduce a tighter coupling that violates the domain separation principle. Callers who need morphogenetic features should assert or type-narrow locally. |

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch1-codereview.md`
**Section:** "P4-001: Return type annotation could be more specific"
