# Finding Ticket: Assertion Without Error Message Context

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B2-CR-06` |
| **Severity** | `P3` |
| **Status** | `closed` |
| **Batch** | 2 |
| **Agent** | `codereview` |
| **Domain** | `kasmina` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/kasmina/host.py` |
| **Line(s)** | `562` |
| **Function/Class** | `MorphogeneticModel.forward()` |

---

## Summary

**One-line summary:** `assert prev_segment is not None` provides no context on failure - makes debugging harder.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The assertion lacks an error message explaining why `prev_segment` must not be None or what conditions could cause it.

### Code Evidence

```python
# /home/john/esper-lite/src/esper/kasmina/host.py:562

assert prev_segment is not None  # No context
```

---

## Recommended Fix

Add descriptive message:

```python
assert prev_segment is not None, (
    f"prev_segment unexpectedly None at slot {slot_id}. "
    f"This indicates a bug in segment routing - all slots should have a previous segment."
)
```

---

## Resolution

**Status:** Fixed

**Fix:** Added descriptive error messages to both assertions in `forward()` and `fused_forward()` explaining:
1. What failed (prev_segment is None after processing _active_slots)
2. What this indicates (control flow bug - early return should handle empty slots)

**Changes:**
- `src/esper/kasmina/host.py`: Lines 568-571 and 595-598

**Verification:**
- 14/14 morphogenetic model tests pass

**Sign-off:** Approved by `feature-dev:code-reviewer`

**Commits:** (pending)

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch2-codereview.md`
**Section:** "File-by-File Analysis" - host.py - P3

---

## Cross-Review

| Agent | Verdict | Evaluation |
|-------|---------|------------|
| **DRL** | ENDORSE | Segment routing is critical for credit assignment in modular RL - when seeds receive gradients from the wrong segment, learning signals become corrupted. Clear assertion messages accelerate debugging training instability caused by misrouted activations. |
| **PyTorch** | ENDORSE | Assertions in forward() become graph breaks under torch.compile if they depend on tensor values; this one checks Python object identity so it is safe, but a descriptive message aids debugging when graph tracing fails. Better error context is cheap and helps diagnose issues in compiled model paths. |
| **CodeReview** | ENDORSE | Assertions without messages are a maintainability anti-pattern; when failures occur in production, developers waste time tracing back to understand the invariant. The suggested fix with slot context and explanation of the routing contract is exactly the right level of detail for fast debugging. |
