# Finding Ticket: Missing Test Coverage for GradientEMATracker

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B7-PT-04` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 7 |
| **Agent** | `pytorch` |
| **Domain** | `simic/telemetry` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/telemetry/gradient_ema.py` |
| **Line(s)** | All |
| **Function/Class** | `GradientEMATracker` |

---

## Summary

**One-line summary:** Stateful EMA tracker has no test coverage for update/drift/serialization.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [x] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

`GradientEMATracker` is a stateful component that:
1. Tracks exponential moving averages of gradient metrics
2. Computes drift from EMA for anomaly detection
3. Provides `state_dict()` / `load_state_dict()` for checkpointing

Grep shows NO tests exist:
```bash
grep -r "GradientEMATracker" tests/
# No results
```

Stateful components are particularly important to test:
- EMA warmup behavior (first N updates)
- Drift calculation edge cases
- State serialization/deserialization roundtrip
- Momentum parameter sensitivity

---

## Recommended Fix

Add comprehensive tests:

```python
# tests/simic/telemetry/test_gradient_ema.py

class TestGradientEMATracker:
    def test_first_update_returns_zero_drift(self):
        tracker = GradientEMATracker()
        tracker.update(1.0, 0.5)
        assert tracker.norm_drift == 0.0
        assert tracker.health_drift == 0.0

    def test_drift_increases_with_deviation(self):
        tracker = GradientEMATracker()
        tracker.update(1.0, 0.5)  # Initialize
        tracker.update(10.0, 0.5)  # Large deviation
        assert tracker.norm_drift > 0.5

    def test_state_dict_roundtrip(self):
        tracker = GradientEMATracker()
        tracker.update(1.0, 0.5)
        tracker.update(2.0, 0.6)

        state = tracker.state_dict()
        tracker2 = GradientEMATracker()
        tracker2.load_state_dict(state)

        assert tracker2.ema_norm == tracker.ema_norm
        assert tracker2.ema_health == tracker.ema_health
```

---

## Verification

### How to Verify the Fix

- [ ] Create test_gradient_ema.py
- [ ] Test update, drift, state_dict, load_state_dict
- [ ] Achieve >90% coverage for gradient_ema.py

---

## Related Findings

- B7-DRL-01: GradientEMATracker instantiated but never used (dead code)
- B7-PT-05: Missing tests for LSTMHealthMetrics

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `REFINE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** Tracker is dead code (instantiated but never called). Testing dead code is lower value than wiring it up. Reframe: P2 for wiring into PPO update path, P3 for tests. Integration point matters - should call after each PPO update, not after rollout.

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |

**Evaluation:** Confirmed zero test coverage. EMA drift calculation has numerical edge cases (small/large/zero norms). state_dict roundtrip is critical for checkpoint resume. Pure Python - trivial to test. High ROI for low cost.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `REFINE` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** Confirmed no tests. BUT component is dead code (instantiated at vectorized.py:1687 but never called). Per CLAUDE.md, should wire first then test. **Downgrade to P3** - testing unwired component is lower priority than integrating it.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch7-pytorch.md`
**Section:** "No test coverage for stateful EMA tracker"

**Report file:** `docs/temp/2712reports/batch7-drl.md`
**Section:** "Missing tests for GradientEMATracker, LSTMHealthMetrics"
