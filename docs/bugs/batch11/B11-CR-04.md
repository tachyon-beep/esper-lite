# Finding Ticket: Duplicate EPISODE_OUTCOME Emitted on Rollback Episodes

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B11-CR-04` |
| **Severity** | `P2` |
| **Status** | `fixed` |
| **Batch** | 11 |
| **Agent** | `correctness` |
| **Domain** | `simic/training` |
| **Assignee** | |
| **Created** | 2026-01-01 |
| **Updated** | 2026-01-01 |
| **Fixed** | 2026-01-01 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/training/vectorized.py` |
| **Line(s)** | `3211` (first emission), `3391` (second emission) |
| **Function/Class** | `train_ppo_vectorized()` |

---

## Summary

**One-line summary:** B11-CR-02 fix re-emitted EPISODE_OUTCOME telemetry for rollback episodes, creating duplicate events for the same episode_idx and inflating episode counts in downstream analytics.

**Category:**
- [x] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

**B11-CR-02 fix introduced duplicate telemetry emissions:**

**Execution timeline for rollback episodes:**

1. **Epoch loop (line 3176):** Episode ends (`epoch == max_epochs`)
   - Line 3178: Compute metrics from PRE-PENALTY `episode_rewards`
   - Line 3196: Create `EpisodeOutcome` with PRE-PENALTY values
   - Line 3211: **Emit EPISODE_OUTCOME #1** (episode_reward=+100, stability=0.95) ← PRE-PENALTY

2. **Rollback block (line 3345):** After epoch loop completes
   - Line 3345: Apply penalty to `episode_rewards`
   - Line 3352-3385: Recompute metrics with POST-PENALTY values
   - Line 3391: **Emit EPISODE_OUTCOME #2** (episode_reward=+0, stability=0.60) ← POST-PENALTY

**Result:** Two `EPISODE_OUTCOME` events with the same `episode_idx`, different data.

**Problem:**
- ✅ `env_rollback_occurred[env_idx]` is set at line 2657 BEFORE the epoch loop emits at line 3211
- ✅ We COULD check this flag to suppress the first emission
- ❌ B11-CR-02 didn't check the flag, so both emissions happened

### Impact

Downstream analytics consuming telemetry events will:
- ❌ **Double-count episodes:** See 2 outcomes for the same `episode_idx`
- ❌ **Get conflicting data:** First event says reward=+100, second says reward=+0
- ❌ **Break "one outcome per episode" assumptions:** Analytics expecting 1:1 mapping
- ❌ **Skew episode completion counts:** Dashboards show inflated episode totals
- ❌ **Incorrect Pareto frontiers:** Duplicate data points in multi-objective analysis

**Example:**
```
Episode 5 with rollback:
  Event #1 (line 3211): episode_idx=5, episode_reward=+100, stability=0.95  (PRE-PENALTY)
  Event #2 (line 3391): episode_idx=5, episode_reward=+0, stability=0.60    (POST-PENALTY)

Analytics that count events: 2 episodes completed ❌ (should be 1)
Analytics that use "last wins": Correct values, but inefficient
Analytics that average: Mean of [(+100, 0.95), (+0, 0.60)] = skewed
```

---

## Fix Applied

**Commit:** `[current commit]`

**Approach:** Suppress first emission for rollback episodes, emit once with corrected values

**Changes made:**

1. **Line 3211:** Added rollback check to suppress first emission
   ```python
   # BEFORE (B11-CR-02):
   if env_state.telemetry_cb:
       env_state.telemetry_cb(TelemetryEvent(...))  # Always emit

   # AFTER (B11-CR-04 fix):
   # B11-CR-04 fix: Skip emission for rollback episodes (will emit corrected outcome later)
   if env_state.telemetry_cb and not env_rollback_occurred[env_idx]:
       env_state.telemetry_cb(TelemetryEvent(...))  # Emit only if NO rollback
   ```

2. **Line 3391:** Emit corrected outcome for rollback episodes (one event total)
   ```python
   # 5. Emit corrected EPISODE_OUTCOME telemetry
   # B11-CR-04 fix: First emission was suppressed for rollback episodes
   # (see line 3211), so we emit the corrected outcome here (one event total).
   if env_state.telemetry_cb:
       env_state.telemetry_cb(TelemetryEvent(...))  # Corrected values
   ```

**Execution flow after fix:**

**Non-rollback episodes:**
- Line 2657: `env_rollback_occurred[env_idx]` remains `False`
- Line 3211: `if env_state.telemetry_cb and not env_rollback_occurred[env_idx]:` → **TRUE**
  - Emit EPISODE_OUTCOME once (correct values)
- Line 3391: Rollback block doesn't run → no second emission
- **Total: 1 emission** ✅

**Rollback episodes:**
- Line 2657: `env_rollback_occurred[env_idx] = True`
- Line 3211: `if env_state.telemetry_cb and not env_rollback_occurred[env_idx]:` → **FALSE**
  - Skip emission (PRE-PENALTY values would be wrong)
- Line 3345: Penalty applied, metrics recomputed
- Line 3391: Emit EPISODE_OUTCOME once (corrected POST-PENALTY values)
- **Total: 1 emission** ✅

**Rationale:**
- **One event per episode:** No duplicates for downstream analytics
- **Correct values:** Rollback episodes always emit POST-PENALTY values
- **Timing:** `env_rollback_occurred` is set before first emission, so we can check it
- **Backwards compatible:** Non-rollback episodes unchanged (still emit once at line 3211)

**Tests passed:**
- [x] All 4 reward telemetry flow tests
- [x] Vectorized determinism test
- [x] All integration tests

---

## Verification

### How to Verify the Fix

1. **Create test with rollback episode:**
   ```python
   # Trigger governor rollback (NaN/Inf/Loss spike)
   # Verify telemetry callback receives exactly ONE EPISODE_OUTCOME event
   # Verify event contains POST-PENALTY values
   ```

2. **Check non-rollback episodes:**
   ```python
   # Normal episode (no rollback)
   # Verify telemetry callback receives exactly ONE EPISODE_OUTCOME event
   # Verify event emitted at line 3211 (epoch loop)
   ```

3. **Count unique episode_idx values:**
   ```python
   # Process all EPISODE_OUTCOME events
   # Count unique episode_idx values
   # Should equal total episodes (no duplicates)
   ```

---

## Root Cause Analysis

**How did this happen?**

B11-CR-02 focused on **data correctness** (recomputing metrics after penalty) but didn't consider **telemetry correctness** (emission timing).

**The mistake:**
- I assumed re-emitting was necessary to get corrected values to consumers
- I didn't check if we could suppress the first emission instead
- I didn't verify the timing of `env_rollback_occurred` flag

**Lesson learned:**
- When fixing telemetry bugs, consider both data correctness AND emission semantics
- Check for flags/state that can prevent incorrect emissions, not just correct them after
- Verify no duplicate events for same entity/episode

---

## Related Findings

- **B11-CR-02:** Fixed metrics sequencing (compute after penalty), introduced duplicate emission bug
- **B11-CR-04:** Fixed duplicate emission bug by suppressing first emission for rollback episodes

---

## Notes

- This bug was introduced by B11-CR-02 fix itself (regression)
- Only affected rollback episodes (episodes with governor intervention)
- Non-rollback episodes unaffected
- Severity P2 because it inflates episode counts and skews analytics, but doesn't affect PPO learning
