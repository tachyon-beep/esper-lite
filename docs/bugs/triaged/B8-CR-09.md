# Finding Ticket: Magic Number for Gradient Ratio EMA

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B8-CR-09` |
| **Severity** | `P4` |
| **Status** | `open` |
| **Batch** | 8 |
| **Agent** | `codereview` |
| **Domain** | `simic/training` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/training/vectorized.py` |
| **Line(s)** | `2336` |
| **Function/Class** | `train_ppo_vectorized()` |

---

## Summary

**One-line summary:** 0.9/0.1 EMA momentum values are hardcoded magic numbers.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# Line 2336
ema = 0.9 * prev_ema + 0.1 * current_ratio
```

The 0.9/0.1 momentum values are:
1. Hardcoded inline
2. Not consistent with other EMA computations in the codebase
3. Should be leyline constants for consistency

### Impact

- **Inconsistency**: Different EMA decays across codebase
- **Maintainability**: Hard to find and update all EMA constants
- **Documentation**: No explanation of why 0.9 was chosen

---

## Recommended Fix

Move to leyline constants:

```python
# In leyline/constants.py
GRADIENT_RATIO_EMA_DECAY = 0.9

# In vectorized.py
from esper.leyline.constants import GRADIENT_RATIO_EMA_DECAY

ema = GRADIENT_RATIO_EMA_DECAY * prev_ema + (1 - GRADIENT_RATIO_EMA_DECAY) * current_ratio
```

---

## Verification

### How to Verify the Fix

- [ ] Add GRADIENT_RATIO_EMA_DECAY to leyline constants
- [ ] Update vectorized.py to use constant
- [ ] Review other EMA usages for consistency

---

## Related Findings

- B8-DRL-11: Contribution velocity EMA also hardcoded

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch8-codereview.md`
**Section:** "[P4-4] Magic number for gradient ratio EMA"
