# Finding Ticket: shaped_reward_ratio Includes Unset and Double-Counted Fields

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B6-PT-02` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 6 |
| **Agent** | `pytorch` |
| **Domain** | `simic/rewards` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/rewards/reward_telemetry.py` |
| **Line(s)** | `84-99` |
| **Function/Class** | `RewardComponentsTelemetry.shaped_reward_ratio` |

---

## Summary

**One-line summary:** `shaped_reward_ratio` calculation includes fields that are never set (always 0) and double-counted values.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
shaped = (
    self.stage_bonus        # NEVER SET - always 0.0
    + self.pbrs_bonus
    + self.synergy_bonus
    + self.action_shaping
    + self.terminal_bonus
    + self.fossilize_terminal_bonus  # DOUBLE-COUNTED - already in terminal_bonus
    + self.hindsight_credit  # NEVER SET in main path
    + self.compute_rent
    + self.alpha_shock
    + self.blending_warning
    + self.holding_warning
    + self.ratio_penalty
)
```

Issues:
1. `stage_bonus` is never set by any reward function (always 0.0)
2. `hindsight_credit` is never set in the main reward path
3. `fossilize_terminal_bonus` is ALREADY INCLUDED in `terminal_bonus` (see rewards.py line 798)

This makes `shaped_reward_ratio` unreliable for reward hacking detection.

---

## Recommended Fix

1. Remove unset fields from calculation
2. Fix double-counting of fossilize_terminal_bonus:

```python
shaped = (
    self.pbrs_bonus
    + self.synergy_bonus
    + self.action_shaping
    + self.terminal_bonus  # Already includes fossilize_terminal_bonus
    # + self.fossilize_terminal_bonus  # REMOVE - double-counted
    + self.compute_rent
    + self.alpha_shock
    + self.blending_warning
    + self.holding_warning
    + self.ratio_penalty
)
```

---

## Verification

### How to Verify the Fix

- [ ] Remove stage_bonus from calculation (or set it somewhere)
- [ ] Remove hindsight_credit from calculation (or set it somewhere)
- [ ] Fix fossilize_terminal_bonus double-counting
- [ ] Add unit test for shaped_reward_ratio correctness

---

## Related Findings

- B6-CR-08: ratio_penalty in shaping terms questionable
- B6-DRL-04: stage_bonus never set
- B6-PT-04: base_acc_delta dead code
- B6-PT-05: hindsight_credit dead code

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch6-pytorch.md`
**Section:** "P2-3: shaped_reward_ratio May Be Misleading"

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** Incorrect shaped_reward_ratio undermines reward diagnostics used to detect reward hacking - a critical concern in RL training. Double-counting `fossilize_terminal_bonus` inflates the shaped component, potentially masking cases where sparse rewards dominate (which could indicate policy collapse). While no direct tensor operations are involved, this metric directly informs training health monitoring. The fix is low-risk and improves telemetry accuracy.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** The `shaped_reward_ratio` metric is intended to detect reward hacking and shaping pathologies. If it includes unset fields (always 0) and double-counts `fossilize_terminal_bonus`, the ratio becomes unreliable for detecting when shaped rewards dominate extrinsic signal. This is exactly the kind of metric drift that masks reward hacking. The double-counting is particularly insidious as it inflates the shaped component, potentially triggering false positives or masking true positives. Fix urgently to restore diagnostic integrity.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** Verified the double-counting claim: `terminal_bonus` does include `fossilize_terminal_bonus` (line 798), but both are separately added in `shaped_reward_ratio`. Also confirmed `stage_bonus` and `hindsight_credit` are set in some paths (vectorized.py, emitters.py) but not all. The fix should either (a) remove `fossilize_terminal_bonus` from the ratio calculation since it's already in `terminal_bonus`, or (b) track it separately. The ticket correctly identifies a metric corruption issue that undermines reward hacking detection.
