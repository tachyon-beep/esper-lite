# Finding Ticket: head_names List Duplicated Instead of Using HEAD_NAMES

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B4-PT-04` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 4 |
| **Agent** | `pytorch` |
| **Domain** | `simic` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/agent/ppo.py` |
| **Line(s)** | `772-773` |
| **Function/Class** | `PPOAgent.update()` |

---

## Summary

**One-line summary:** Local `head_names` list duplicates `HEAD_NAMES` from leyline plus "value" - should reuse the constant.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The code defines head names locally:

```python
# Lines 772-773
head_names = ["op", "slot", "blueprint", "style", "tempo",
              "alpha_target", "alpha_speed", "alpha_curve", "value"]
```

But `HEAD_NAMES` is already defined in leyline and imported elsewhere. The "value" head is the only addition.

### Why This Matters

- If HEAD_NAMES changes in leyline, this local list will drift
- The duplication violates the project's leyline policy: "All new constants must be placed in leyline"
- Maintenance burden

---

## Recommended Fix

Use the leyline constant:

```python
# Import at top of file
from esper.leyline import HEAD_NAMES

# At line 772-773
head_names = list(HEAD_NAMES) + ["value"]
```

Or if this pattern is common, add a constant to leyline:

```python
# In leyline/constants.py
HEAD_NAMES_WITH_VALUE: tuple[str, ...] = HEAD_NAMES + ("value",)
```

---

## Verification

### How to Verify the Fix

- [ ] Replace local list with `list(HEAD_NAMES) + ["value"]`
- [ ] Verify all head names are still captured
- [ ] Run `pytest tests/simic/test_ppo.py -v`

---

## Related Findings

None.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch4-pytorch.md`
**Section:** "P2 (Performance)" (PPO-4)

---

## Cross-Review

| Reviewer | Verdict | Date |
|----------|---------|------|
| Code Review Specialist | **ENDORSE** | 2024-12-27 |
| PyTorch Specialist | **NEUTRAL** | 2024-12-27 |

**Code Review Evaluation:** Valid leyline policy violation. `HEAD_NAMES` is already imported at line 40 and used elsewhere (line 539, 541, 671). The local `head_names` at 772-773 should be `list(HEAD_NAMES) + ["value"]`. Simple fix, prevents drift if HEAD_NAMES changes in leyline.

**PyTorch Evaluation:** This is a code organization issue, not a PyTorch performance or torch.compile concern. The ticket is correctly categorized as API design, not performance. No PyTorch-specific implications - the local list vs leyline constant has zero runtime difference. Defer to Code Review specialist on priority.

| DRL Specialist | **ENDORSE** | 2024-12-27 |

**DRL Evaluation:** Clear leyline policy violation. HEAD_NAMES is already imported (line 40) and used for per-head entropy tracking (lines 539, 541) and KL computation (line 671). The local list at 772-773 adds "value" for per-head gradient norm tracking (P4-6 diagnostic). Fix is trivial: `list(HEAD_NAMES) + ["value"]`. No RL correctness implications - gradient norms are telemetry, not training signals. A leyline constant would be overkill for this single use site.
