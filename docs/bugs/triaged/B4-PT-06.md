# Finding Ticket: Magic Numbers in ppo.py

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B4-PT-06` |
| **Severity** | `P4` |
| **Status** | `open` |
| **Batch** | 4 |
| **Agent** | `pytorch` |
| **Domain** | `simic` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/agent/ppo.py` |
| **Line(s)** | `459, 694` |
| **Function/Class** | `PPOAgent` |

---

## Summary

**One-line summary:** Magic numbers (3.0 cap, 1.5x multiplier) lack explanatory comments or named constants.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

Two unexplained magic numbers:

```python
# Line 459: Cap scale_factor at 3.0
scale_factor = min(scale_factor, 3.0)

# Line 694: 1.5x KL threshold multiplier
if approx_kl > self.kl_target * 1.5:
```

Neither has a comment explaining why these specific values were chosen.

---

## Recommended Fix

Add named constants or comments:

```python
# Line 459
# Cap entropy floor scaling at 3x to prevent runaway exploration
# from sparse action masks. Empirically, >3x causes policy instability.
MAX_ENTROPY_FLOOR_SCALE = 3.0
scale_factor = min(scale_factor, MAX_ENTROPY_FLOOR_SCALE)

# Line 694
# Stop early if KL exceeds target by 50%. This threshold balances
# sample efficiency (more epochs) vs policy stability (smaller updates).
# 1.5x is standard in PPO implementations (Schulman et al. 2017).
KL_EARLY_STOP_MULTIPLIER = 1.5
if approx_kl > self.kl_target * KL_EARLY_STOP_MULTIPLIER:
```

---

## Verification

### How to Verify the Fix

- [ ] Add constants or comments explaining the values
- [ ] No functional change needed

---

## Related Findings

None.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `NEUTRAL` |
| **Reviewer** | DRL Specialist |

**Evaluation:** The 1.5x KL multiplier (line 694) already has an inline comment: "1.5x multiplier is standard (OpenAI baselines, Stable-Baselines3)". The 3.0 entropy floor cap (line 459) does lack explanation - a brief comment about preventing runaway exploration would help. However, both are well-established PPO hyperparameters (Schulman et al., 2017); extracting to leyline constants feels like over-engineering for rarely-tuned values. Low priority.

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** Valid finding. The 1.5x KL multiplier is PPO standard (Schulman 2017, OpenAI baselines, Stable-Baselines3). The 3.0 entropy floor cap prevents log-ratio instability when valid actions are sparse (log(5)/log(2) = 2.32, so 3.0 caps extreme cases). Both should be named constants in leyline per project conventions: `DEFAULT_KL_EARLY_STOP_MULTIPLIER = 1.5` and `MAX_ENTROPY_FLOOR_SCALE = 3.0`.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch4-pytorch.md`
**Section:** "P4 (Style/Minor)" (PPO-8)
