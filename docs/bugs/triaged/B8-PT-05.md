# Finding Ticket: Fragile locals() Check for reward_components

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B8-PT-05` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 8 |
| **Agent** | `pytorch` |
| **Domain** | `simic/training` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/training/vectorized.py` |
| **Line(s)** | `2652, 2659, 2884` |
| **Function/Class** | `train_ppo_vectorized()` |

---

## Summary

**One-line summary:** `"reward_components" in locals()` pattern is fragile and can break silently.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# Lines 2652, 2659, 2884
if collect_reward_summary and "reward_components" in locals():
    reward_components.hindsight_credit = hindsight_credit_applied
```

The `"reward_components" in locals()` pattern:
1. Depends on execution path (variable may or may not be defined)
2. Can silently skip the block if variable is renamed
3. Is unusual Python and surprises readers
4. Could break under torch.compile if locals() is dynamically inspected

### Impact

- **Silent failures**: If `reward_components` is renamed, code silently skips
- **torch.compile risk**: Dynamic `locals()` inspection causes graph breaks
- **Code smell**: Unusual pattern that's hard to maintain

---

## Recommended Fix

Use explicit Optional variable:

```python
# At function start:
reward_components: RewardComponents | None = None

# When creating:
if collect_reward_summary:
    reward_components = RewardComponents(...)

# When using:
if reward_components is not None:
    reward_components.hindsight_credit = hindsight_credit_applied
```

---

## Verification

### How to Verify the Fix

- [ ] Replace `in locals()` checks with Optional variable pattern
- [ ] Initialize variable to None at function start
- [ ] Check with torch.compile for graph breaks

---

## Related Findings

- B8-PT-06: Tuple keys may cause torch.compile graph breaks

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch8-pytorch.md`
**Section:** "P3 - Fragile locals() check"
