# Finding Ticket: Hardcoded env_id=0 in Shapley Telemetry

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B5-PT-07` |
| **Severity** | `P4` |
| **Status** | `open` |
| **Batch** | 5 |
| **Agent** | `pytorch` |
| **Domain** | `simic/attribution` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/attribution/counterfactual.py` |
| **Line(s)** | `453` |
| **Function/Class** | `CounterfactualEngine._emit_shapley_telemetry()` |

---

## Summary

**One-line summary:** Hardcoded `env_id=0` for Shapley telemetry could confuse dashboard consumers.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
env_id=0,  # Shapley computed across all environments
```

The comment notes this is intentional ("computed across the full environment"), but dashboard consumers expecting per-env data might be confused seeing all Shapley telemetry tagged as env_id=0.

---

## Recommended Fix

Either:

1. **Use a sentinel value:**
```python
env_id=-1,  # Sentinel: computed across all environments
```

2. **Expand the comment:**
```python
# env_id=0 is a placeholder - Shapley values are computed across
# all environments in aggregate, not per-environment. Dashboards
# should filter by telemetry_type rather than env_id for Shapley data.
env_id=0,
```

---

## Verification

### How to Verify the Fix

- [ ] Add clarifying comment or use sentinel
- [ ] Update dashboard if needed
- [ ] No functional change

---

## Related Findings

None.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch5-pytorch.md`
**Section:** "P4 - Style/Minor" (ID 2)

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `NEUTRAL` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** This is a telemetry schema design question, not a PyTorch concern. The hardcoded `env_id=0` has no impact on tensor operations or training correctness. Using -1 as a sentinel is a reasonable convention but should be coordinated with Karn dashboard consumers. The expanded comment option is preferable as it documents intent without requiring schema changes.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `NEUTRAL` |
| **Reviewer** | DRL Specialist |

**Evaluation:** From an RL perspective, Shapley value attribution is correctly computed across the full batch of environments since we want to understand each seed module's contribution to aggregate policy performance, not per-environment variance. Using env_id=0 as a placeholder is semantically reasonable given Shapley values are global attributions. The sentinel value (-1) suggestion is marginally better for dashboard filtering, but this is purely a telemetry presentation concern with no impact on RL training or attribution correctness.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `OBJECT` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** This is a non-issue. The code at L453 correctly uses `env_id=0` with a clear inline comment: "Shapley is computed across the full environment." Using a sentinel value like -1 would add unnecessary complexity and require all dashboard consumers to handle a special case. The current approach is standard practice for aggregate metrics - the comment is sufficient documentation. Close as WONTFIX.
