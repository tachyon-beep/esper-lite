# Finding Ticket: Component Sum Tests Missing synergy_bonus

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B6-CR-01` |
| **Severity** | `P1` |
| **Status** | `closed` |
| **Batch** | 6 |
| **Agent** | `codereview` |
| **Domain** | `simic/rewards` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `tests/simic/properties/test_reward_invariants.py`, `tests/simic/test_rewards.py`, `tests/simic/test_reward_telemetry.py` |
| **Line(s)** | `76-85`, `411-418`, `84-92` |
| **Function/Class** | `test_components_sum_to_total` |

---

## Summary

**One-line summary:** Property tests for reward component sums do not include `synergy_bonus`, allowing bugs to pass undetected.

**Category:**
- [x] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [x] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The `test_components_sum_to_total` property test verifies that individual reward components sum to the total reward. However, `synergy_bonus` is computed and added to the reward (rewards.py lines 714-721) but is NOT included in the test's component sum:

```python
# test_reward_invariants.py lines 76-85
component_sum = (
    components.bounded_attribution
    + components.blending_warning
    + components.holding_warning
    + components.pbrs_bonus
    + components.compute_rent
    + components.alpha_shock
    + components.action_shaping
    + components.terminal_bonus
)
# MISSING: + components.synergy_bonus
```

The same issue exists in:
- `tests/simic/test_rewards.py` line 411-418
- `tests/simic/test_reward_telemetry.py` line 84-92

**Evidence synergy_bonus IS populated:** `tests/simic/rewards/test_scaffolding_rewards.py` asserts `components.synergy_bonus > 0`.

---

## Recommended Fix

Add `synergy_bonus` to all three component sum tests:

```python
component_sum = (
    components.bounded_attribution
    + components.blending_warning
    + components.holding_warning
    + components.pbrs_bonus
    + components.compute_rent
    + components.alpha_shock
    + components.action_shaping
    + components.terminal_bonus
    + components.synergy_bonus  # ADD THIS
)
```

---

## Verification

### How to Verify the Fix

- [ ] Add `synergy_bonus` to test_reward_invariants.py
- [ ] Add `synergy_bonus` to test_rewards.py
- [ ] Add `synergy_bonus` to test_reward_telemetry.py
- [ ] Run tests with scenarios where `synergy_bonus > 0` to verify sum matches

---

## Related Findings

- B6-DRL-03: Synergy bonus not protected by anti-stacking logic
- B6-PT-02: shaped_reward_ratio includes questionable terms

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch6-codereview.md`
**Section:** "P1-1: Component Sum Missing synergy_bonus in Some Tests"

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `NEUTRAL` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** This is a valid test coverage gap with no direct PyTorch implications. The reward computation occurs in pure Python floats and conversion to tensors happens at the training loop level, which is architecturally correct. The missing synergy_bonus in component sum tests is a testing issue that could allow reward accounting bugs to slip through, but poses no numerical stability, memory, or torch.compile concerns. Fix is warranted for test integrity.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** This is a critical finding from an RL perspective. The component sum invariant is essential for verifying reward decomposition correctness, which directly impacts credit assignment and policy gradient estimation. If `synergy_bonus` is added to the total reward (line 719) but not tracked in component sum tests, bugs in synergy computation could go undetected and cause silent reward signal corruption. PBRS guarantees (Ng et al., 1999) only hold when all shaping terms are properly accounted for; missing a component undermines our ability to verify these guarantees experimentally.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** Verified in source: `synergy_bonus` is computed at lines 714-721 of rewards.py and added to the total reward, but the test at lines 76-85 of test_reward_invariants.py omits it from the component sum. This is a clear correctness bug in the test suite that could mask real reward calculation bugs. The fix is trivial and correct - simply add `+ components.synergy_bonus` to all three test locations.

---

## Resolution

### Status: FIXED

**Root cause investigation revealed double failure: missing component AND hiding strategy.**

#### Investigation (Systematic Debugging)

| Phase | Finding |
|-------|---------|
| Phase 1 | Reproduced bug: when `synergy_bonus = 0.085`, component sum differs by 0.085 from total |
| Phase 2 | Strategy `seed_infos()` never generates `interaction_sum > 0`, so `synergy_bonus` always 0.0 in tests |
| Phase 3 | Hypothesis confirmed: adding `synergy_bonus` to component sum fixes accounting |
| Phase 4 | Fixed strategy AND all three test files |

#### Fixes Applied

1. **Strategy fix** (`tests/simic/strategies/reward_strategies.py`):
   - Added `interaction_sum` and `boost_received` fields to `seed_infos()` strategy
   - Now generates non-zero values to properly exercise synergy_bonus path

2. **Test fixes** (all three files):
   - `tests/simic/properties/test_reward_invariants.py`: Added `synergy_bonus`
   - `tests/simic/test_rewards.py`: Added `synergy_bonus`, `blending_warning`, `holding_warning`
   - `tests/simic/test_reward_telemetry.py`: Added `synergy_bonus`, `blending_warning`, `holding_warning`

#### Verification

- [x] All 63 reward tests pass
- [x] All 4 property tests pass (including with new strategy generating synergy_bonus > 0)
- [x] Component sums now correctly account for ALL reward components
