# Finding Ticket: Duplicate GOVERNOR_ROLLBACK Event Emission

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B1-CR-02` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 1 |
| **Agent** | `codereview` |
| **Domain** | `tolaria` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tolaria/governor.py` |
| **Line(s)** | `249-264, 299-312` |
| **Function/Class** | `TolariaGovernor.execute_rollback()` |

---

## Summary

**One-line summary:** Two GOVERNOR_ROLLBACK events are emitted per rollback - one "critical" and optionally one "warning" for key mismatches.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

During `execute_rollback()`, two telemetry events of the same type (GOVERNOR_ROLLBACK) can be emitted:
1. Line ~251: "critical" severity - the main rollback event
2. Line ~301: "warning" severity - optional, when state dict has key mismatches

This could confuse downstream consumers (analytics, dashboards) that expect one event per rollback.

### Code Evidence

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py:249-264

# First emission (always)
hub.emit(TelemetryEvent(
    event_type=TelemetryEventType.GOVERNOR_ROLLBACK,
    severity="critical",
    ...
))

# Later in the same function (lines 299-312)
if missing_keys or unexpected_keys:
    hub.emit(TelemetryEvent(
        event_type=TelemetryEventType.GOVERNOR_ROLLBACK,
        severity="warning",
        ...
    ))
```

### Why This Matters

- Analytics counting "rollback events" will double-count rollbacks with key mismatches
- Dashboard consumers may display duplicate entries
- Unclear semantic - is a key mismatch a separate event or additional context?

---

## System Context

Telemetry events should have clear semantics. One rollback = one event is the expected pattern.

**Relevant architectural principles:**
- [x] Signal-to-Noise Hypothesis (sensors match capabilities) - ambiguous signals reduce clarity
- [ ] Rent Economy (complexity pays rent)
- [ ] Inverted Control Flow (GPU-first)
- [ ] Governor prevents catastrophe
- [ ] No defensive programming policy
- [ ] No legacy code policy

---

## Recommended Fix

### Approach

Choose one of three options:

### Option A: Include key mismatch in primary event (Recommended)

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py

hub.emit(TelemetryEvent(
    event_type=TelemetryEventType.GOVERNOR_ROLLBACK,
    severity="critical",
    data=GovernorRollbackPayload(
        env_id=env_id,
        ...
        missing_keys=tuple(missing_keys) if missing_keys else None,
        unexpected_keys=tuple(unexpected_keys) if unexpected_keys else None,
    ),
))
# Remove the second emit call entirely
```

### Option B: Use distinct event type

```python
# Define GOVERNOR_ROLLBACK_KEY_MISMATCH event type
# Use that for the warning emission
```

### Option C: Document dual-emission behavior

Add explicit documentation that this is intentional behavior.

---

## Verification

### How to Verify the Fix

- [ ] Unit test: Verify only one event is emitted per rollback
- [ ] Unit test: Verify key mismatch info is included when present
- [ ] Integration test: Check analytics pipeline handles the change

### Test Files to Update

- `tests/tolaria/test_governor.py` - update telemetry emission assertions

---

## Related Findings

| Ticket ID | Relationship | Notes |
|-----------|--------------|-------|
| `B1-CR-01` | `related` | Typed payload should include key mismatch fields |

---

## Cross-Review

| Agent | Verdict | Evaluation |
|-------|---------|------------|
| **DRL** | ENDORSE | Duplicate events per rollback will corrupt rollback-frequency metrics used to diagnose training instability. Analytics tracking "rollbacks/epoch" will double-count when key mismatches occur, obscuring true training health signals. |
| **PyTorch** | NEUTRAL | Duplicate telemetry emission is an API design concern, not a PyTorch issue; no impact on CUDA synchronization, memory, or compilation. From a torch perspective, emitting two events is benign - resolve based on observability requirements, not PyTorch constraints. |
| **CodeReview** | ENDORSE | Dual emission of the same event type with different severities creates ambiguous semantics for downstream consumers. The recommended fix (Option A) is correct. Including `missing_keys`/`unexpected_keys` in the primary payload is cleaner than dual emission and aligns with B1-CR-01's typed payload solution. |

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch1-codereview.md`
**Section:** "P3-002: Duplicate telemetry emission for key mismatch warning"
