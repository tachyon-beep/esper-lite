# Finding Ticket: get_entropy_floor Dead Code

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B4-CR-02` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 4 |
| **Agent** | `codereview` |
| **Domain** | `simic` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/agent/ppo.py` |
| **Line(s)** | `423-461` |
| **Function/Class** | `PPOAgent.get_entropy_floor()` |

---

## Summary

**One-line summary:** `get_entropy_floor()` has a TODO noting it may be dead code - `action_mask` is not threaded through callers.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [x] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The `get_entropy_floor()` method computes an adaptive entropy floor based on action mask sparsity, but the method has a TODO comment indicating `action_mask` is not properly threaded through the callers:

```python
def get_entropy_floor(self, head_name: str, action_mask: torch.Tensor | None = None) -> float:
    """Get entropy floor for a head, optionally accounting for mask sparsity.

    TODO: action_mask is not currently threaded through callers - this may be dead code.
    """
```

### Why This Matters

- Dead code increases maintenance burden
- The adaptive entropy feature may have been intended but never completed
- Future developers may waste time trying to understand or fix it

### Current Usage

Looking at callers:
- `get_entropy_coef()` at line ~450 calls `get_entropy_floor()` but passes no action_mask
- The adaptive scaling logic (`mask_density * base_floor`) is effectively unused

---

## Recommended Fix

Either:

**Option A: Remove the feature**
```python
def get_entropy_floor(self, head_name: str) -> float:
    """Get entropy floor for a head."""
    return self.entropy_floor_per_head.get(head_name, self.entropy_floor)
```

**Option B: Thread action_mask through callers**
- Update `get_entropy_coef()` to accept action_mask
- Update PPO update loop to pass action_mask to entropy computation
- Add tests for adaptive entropy floor

---

## Verification

### How to Verify the Fix

- [ ] Decide on Option A (remove) or Option B (implement)
- [ ] Update code accordingly
- [ ] Remove or add tests for entropy floor
- [ ] Run `pytest tests/simic/test_ppo.py -v`

---

## Related Findings

- Duplicated in DRL report (P-4) and PyTorch report (PPO-6)

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch4-codereview.md`
**Section:** "P2 (Performance)" (PPO-1)

---

## Cross-Review (DRL Specialist)

| Verdict | Reviewer | Date |
|---------|----------|------|
| **ENDORSE** | DRL Agent | 2024-12-27 |

Adaptive entropy floors for masked action spaces are a legitimate RL technique (compensates for reduced exploration capacity when actions are constrained) - but dead code is worse than no code.
Either wire `action_mask` through the call chain to enable the feature, or delete the entire adaptive floor mechanism per the project's No Legacy Code Policy.

---

## Cross-Review (PyTorch Specialist)

| Verdict | Reviewer | Date |
|---------|----------|------|
| **ENDORSE** | PyTorch Agent | 2024-12-27 |

Confirmed dead code path: `get_entropy_coef()` calls `get_entropy_floor(action_mask)` at lines 411/419 but receives no mask from callers. The `adaptive_entropy_floor` config flag exists but is never exercised.
Per project No Legacy Code Policy, delete the adaptive logic entirely rather than adding compatibility shims. No torch.compile implications - this is pure Python control flow.

---

## Cross-Review (Code Review Specialist)

| Verdict | Reviewer | Date |
|---------|----------|------|
| **ENDORSE** | Code Review Specialist | 2024-12-27 |

Minor ticket inaccuracy: the actual signature at ppo.py:424 is `get_entropy_floor(self, action_mask)`, not `get_entropy_floor(self, head_name: str, action_mask)` as claimed.
Core finding is valid: ppo.py:752 and emitters.py:309 call `get_entropy_coef()` without action_mask. Per No Legacy Code Policy (CLAUDE.md), Option A (delete) is the correct approach.
