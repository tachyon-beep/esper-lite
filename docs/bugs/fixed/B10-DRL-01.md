# Finding Ticket: Blueprint-to-Index Mapping Duplicated Without Sync Assertion

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B10-DRL-01` |
| **Severity** | `P1` |
| **Status** | `closed` |
| **Batch** | 10 |
| **Agent** | `drl` |
| **Domain** | `tamiyo/policy` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tamiyo/policy/features.py` |
| **Line(s)** | `125-140` |
| **Function/Class** | Module level (`_BLUEPRINT_TO_INDEX`) |

---

## Summary

**One-line summary:** `_BLUEPRINT_TO_INDEX` dict duplicates `BlueprintAction` enum values without synchronization validation.

**Category:**
- [x] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# Lines 125-140 in features.py
_BLUEPRINT_TO_INDEX = {
    "noop": 0,
    "conv_light": 1,
    "conv_medium": 2,
    # ... 13 entries total
}
_NUM_BLUEPRINT_TYPES = 13
```

This mapping is duplicated from `BlueprintAction` enum in `leyline/factored_actions.py` for hot-path performance (comment explains this). However:

1. If `BlueprintAction` gains new members, `_BLUEPRINT_TO_INDEX` won't have them
2. The network would see garbage one-hot encodings for new blueprints
3. **Silent failure** - no runtime error, just incorrect feature encoding
4. Could cause policy to learn wrong associations

### Impact

- **High severity**: Silent incorrect training
- **Root cause**: Code duplication without sync validation
- **Scope**: Any new blueprint addition would break feature encoding

---

## Recommended Fix

Add module-level assertion that validates sync:

```python
from esper.leyline import BlueprintAction

# At module load time - fail fast if drift detected
assert len(_BLUEPRINT_TO_INDEX) == len(BlueprintAction), \
    f"Blueprint index drift: features has {len(_BLUEPRINT_TO_INDEX)}, " \
    f"leyline has {len(BlueprintAction)}"

for bp in BlueprintAction:
    bp_id = bp.to_blueprint_id()
    assert bp_id in _BLUEPRINT_TO_INDEX, f"Missing blueprint: {bp_id}"
    assert _BLUEPRINT_TO_INDEX[bp_id] == bp.value, f"Index mismatch for {bp_id}"
```

Or add a test that validates sync:

```python
def test_blueprint_index_sync():
    """Verify _BLUEPRINT_TO_INDEX matches BlueprintAction enum."""
    from esper.tamiyo.policy.features import _BLUEPRINT_TO_INDEX
    from esper.leyline import BlueprintAction

    assert len(_BLUEPRINT_TO_INDEX) == len(BlueprintAction)
    for bp in BlueprintAction:
        assert _BLUEPRINT_TO_INDEX[bp.to_blueprint_id()] == bp.value
```

---

## Verification

### How to Verify the Fix

- [ ] Add module-level assertion OR dedicated test
- [ ] Verify assertion catches intentional drift (temporarily modify one value)
- [ ] Add to CI to prevent future drift

---

## Related Findings

- B10-CR-02: `_BLUEPRINT_TO_INDEX` duplication risk (same finding from CodeReview)

---

## Appendix

### Original Report Reference

**Report files:**
- `docs/temp/2712reports/batch10-drl.md` Section: FE-1
- `docs/temp/2712reports/batch10-codereview.md` Section: P3-2
- `docs/temp/2712reports/batch10-pytorch.md` Section: Blueprint Mapping Synchronization

---

## Resolution

### Final Fix Description

Added `test_blueprint_index_sync_with_leyline()` to `tests/tamiyo/policy/test_features.py` that validates:

1. `len(_BLUEPRINT_TO_INDEX) == len(BlueprintAction)` — count matches
2. `_NUM_BLUEPRINT_TYPES == len(BlueprintAction)` — constant matches
3. Each `BlueprintAction` has a corresponding dict entry
4. Each dict entry has the correct index value

Code reviewer recommended against module-level assertion since:
- This is a static synchronization issue (code-level contract), not runtime data corruption
- CI test coverage catches drift immediately on first test run
- Module-level assertion would add ~10-50μs to every import on the hot path

### Files Changed

- `tests/tamiyo/policy/test_features.py` — Added `test_blueprint_index_sync_with_leyline()`

### Verification

- [x] Test passes: 15/15 features tests pass
- [x] Error messages provide actionable fix instructions
- [x] CI will catch any future drift

### Sign-off

**Code Reviewer:** APPROVED — "The test is production-ready and follows project guidelines perfectly. Test coverage is excellent (validates count, constant, completeness, and index correctness). No module-level assertion needed."
