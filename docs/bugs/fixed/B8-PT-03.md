# Fix: Compiled Train Step Caches Fallback Permanently

---

## Resolution Summary

| Field | Value |
|-------|-------|
| **Ticket ID** | `B8-PT-03` |
| **Status** | `fixed` |
| **Fix Date** | 2025-12-29 |
| **Resolution** | Only cache successful compilations; failures return fallback without caching |

---

## Problem

The original code used `@functools.cache` on `_get_compiled_train_step()`:

```python
@functools.cache
def _get_compiled_train_step(use_compile: bool = True):
    if use_compile:
        try:
            return torch.compile(_train_step_impl, mode="default", dynamic=True)
        except Exception as e:
            logger.warning(...)
            return _train_step_impl  # Cached forever!
    return _train_step_impl
```

If `torch.compile()` failed once (e.g., GPU memory pressure, driver glitch), the uncompiled fallback was cached permanently for the process lifetime, causing 2-5x slowdown with no recovery path.

---

## Fix

Replaced `@functools.cache` with explicit module-level cache that only stores successful compilations:

```python
_compiled_train_step_cache: Callable[...] | None = None

def _get_compiled_train_step(use_compile: bool = True):
    global _compiled_train_step_cache

    if not use_compile:
        return _train_step_impl

    if _compiled_train_step_cache is not None:
        return _compiled_train_step_cache

    try:
        compiled = torch.compile(_train_step_impl, mode="default", dynamic=True)
        _compiled_train_step_cache = compiled  # Only cache on success
        return compiled
    except Exception as e:
        logger.warning("...will retry on next call...")
        return _train_step_impl  # NOT cached - will retry
```

---

## Verification

- [x] Modify caching to not persist failures
- [x] Test recovery after simulated compilation failure
- [x] PyTorch specialist review approved

### Test Cases Added

- `test_compile_retry_after_transient_failure` - Verifies retry after failure
- `test_use_compile_false_bypasses_compilation` - Verifies bypass path
- `test_successful_compile_is_cached` - Verifies success caching

---

## Files Changed

| File | Change |
|------|--------|
| `src/esper/simic/training/helpers.py` | Replace `@functools.cache` with explicit success-only cache |
| `tests/simic/test_training_helper.py` | Add `TestCompiledTrainStepCache` test class |

---

## Thread Safety Note

The fix maintains thread safety. Worst-case race: two threads both compile successfully, one wins the write. No data corruption possible. Failure paths are not cached, allowing retry.
