# Finding Ticket: Style Mask Logic Duplicated Between get_action and evaluate_actions

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B9-PT-03` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 9 |
| **Agent** | `pytorch` |
| **Domain** | `tamiyo/networks` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tamiyo/networks/factored_lstm.py` |
| **Line(s)** | `498-508`, `613-625` |
| **Function/Class** | `get_action()`, `evaluate_actions()` |

---

## Summary

**One-line summary:** Style-irrelevance mask logic is duplicated between get_action and evaluate_actions.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# In get_action() - Lines 498-508
style_irrelevant = (actions["op"] != LifecycleOp.GERMINATE) & (
    actions["op"] != LifecycleOp.SET_ALPHA_TARGET
)
style_mask_override[style_irrelevant] = False
style_mask_override[style_irrelevant, int(GerminationStyle.SIGMOID_ADD)] = True

# In evaluate_actions() - Lines 613-625 (essentially identical)
style_irrelevant = (actions["op"] != LifecycleOp.GERMINATE) & (
    actions["op"] != LifecycleOp.SET_ALPHA_TARGET
)
style_mask_override[style_irrelevant] = False
style_mask_override[style_irrelevant, int(GerminationStyle.SIGMOID_ADD)] = True
```

The logic "when op is not GERMINATE or SET_ALPHA_TARGET, force style to SIGMOID_ADD" is repeated in both methods.

### Impact

- **Maintenance burden**: Changes must be made in two places
- **Divergence risk**: If one is updated and the other forgotten, inconsistent behavior
- **Code bloat**: Unnecessary repetition

---

## Recommended Fix

Extract to a helper method:

```python
def _apply_style_irrelevance_mask(
    self,
    style_mask: torch.Tensor,
    ops: torch.Tensor,
) -> torch.Tensor:
    """Force style to SIGMOID_ADD when op doesn't use style."""
    style_irrelevant = (ops != LifecycleOp.GERMINATE) & (
        ops != LifecycleOp.SET_ALPHA_TARGET
    )
    # Clone to avoid mutating input
    result = style_mask.clone()
    result[style_irrelevant] = False
    result[style_irrelevant, int(GerminationStyle.SIGMOID_ADD)] = True
    return result
```

Then use in both methods:

```python
# In get_action()
style_mask_override = self._apply_style_irrelevance_mask(masks["style"], actions["op"])

# In evaluate_actions()
style_mask_override = self._apply_style_irrelevance_mask(masks["style"], actions["op"])
```

---

## Verification

### How to Verify the Fix

- [ ] Extract helper method
- [ ] Verify behavior unchanged in both paths
- [ ] Add unit test for the helper

---

## Related Findings

- B9-PT-01: Style mask clone overhead (related tensor allocation)

---

## Appendix

### Original Report Reference

**Report files:**
- `docs/temp/2712reports/batch9-codereview.md` Section: P2-B (mentions duplication)
- `docs/temp/2712reports/batch9-drl.md` Section: N1
- `docs/temp/2712reports/batch9-pytorch.md` Section: P4
