# Finding Ticket: hindsight_credit is Dead Code in Main Path

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B6-PT-05` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 6 |
| **Agent** | `pytorch` |
| **Domain** | `simic/rewards` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/rewards/reward_telemetry.py` |
| **Line(s)** | `43` |
| **Function/Class** | `RewardComponentsTelemetry` |

---

## Summary

**One-line summary:** `hindsight_credit` field is defined but never set in the main reward computation path.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [x] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [x] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
@dataclass(slots=True)
class RewardComponentsTelemetry:
    # ...
    hindsight_credit: float = 0.0  # Never set in main path
```

The `hindsight_credit` field:
1. Is defined in telemetry dataclass
2. Is never set by `compute_contribution_reward`
3. Is included in `shaped_reward_ratio` calculation (contributing 0)
4. May be set by `compute_scaffold_hindsight_credit` but that function is not called in main reward loop

This appears to be infrastructure for a feature that was planned but never fully integrated.

---

## Recommended Fix

Either:

**Option 1 - Remove (if truly unused):**
```python
# Remove hindsight_credit from dataclass
# Remove from shaped_reward_ratio calculation
# Remove from to_dict()
```

**Option 2 - Wire it up (if feature is wanted):**
Call `compute_scaffold_hindsight_credit` from main reward function and populate the field.

---

## Verification

### How to Verify the Fix

- [ ] Search for hindsight_credit assignments in production code
- [ ] If only in tests, decide: remove or wire up
- [ ] Update shaped_reward_ratio if removing
- [ ] Run tests to verify

---

## Related Findings

- B6-DRL-04: stage_bonus is also dead code
- B6-PT-04: base_acc_delta is also dead code
- B6-PT-02: shaped_reward_ratio includes unset fields

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch6-pytorch.md`
**Section:** "P3-4: hindsight_credit is dead code"

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** Similar to B6-PT-04, this is dead code that pollutes telemetry. The additional concern here is that `hindsight_credit` is included in `shaped_reward_ratio` calculation (per B6-PT-02), so removing it is part of the broader fix for accurate reward diagnostics. The existence of `compute_scaffold_hindsight_credit` suggests planned functionality - recommend a TODO comment if removal is chosen, or wire it up if the feature is still wanted.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** Hindsight credit assignment is a valuable technique (cf. HER - Andrychowicz et al., 2017) for sparse reward settings. The infrastructure exists (`compute_scaffold_hindsight_credit` function) but is never wired into the main reward loop. This represents either incomplete feature integration or dead code. If hindsight credit was intentionally deferred, document why in a TODO; if abandoned, delete per No Legacy Code Policy. The current state where the field exists, is included in `shaped_reward_ratio`, but is always 0.0 is the worst of both worlds.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `OBJECT` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** The ticket's claim is **incorrect**. Grep shows `hindsight_credit` IS set in `vectorized.py:2653` (`reward_components.hindsight_credit = hindsight_credit_applied`) and read in `emitters.py:882-894`. Additionally, `parallel_env_state.py:186` initializes `pending_hindsight_credit`. The feature appears to be wired up, not dead. The ticket should be closed as invalid or re-investigated to verify the call paths are reachable.
