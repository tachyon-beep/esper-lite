# Finding Ticket: head_entropies/head_grad_norms Typing Could Be More Specific

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B4-CR-07` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 4 |
| **Agent** | `codereview` |
| **Domain** | `simic` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/agent/types.py` |
| **Line(s)** | `65-66` |
| **Function/Class** | `PPOUpdateMetrics` |

---

## Summary

**One-line summary:** `head_entropies` and `head_grad_norms` are typed as `dict[str, list[float]]` but should include all HEAD_NAMES keys.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The TypedDict uses a generic `dict[str, list[float]]`:

```python
class PPOUpdateMetrics(TypedDict, total=False):
    # ...
    head_entropies: dict[str, list[float]]
    head_grad_norms: dict[str, list[float]]
```

This doesn't capture that the keys should be from `HEAD_NAMES + ["value"]`. A TypedDict for the inner structure would be more precise.

### Current State

The code that produces these dicts does use all head names consistently, so this is a type annotation improvement, not a bug.

---

## Recommended Fix

**Option A: Document the keys**

```python
# Keys are HEAD_NAMES + ["value"]: op, slot, blueprint, style, tempo,
# alpha_target, alpha_speed, alpha_curve, value
head_entropies: dict[str, list[float]]
```

**Option B: Use a TypedDict for structure**

```python
class HeadMetrics(TypedDict):
    op: list[float]
    slot: list[float]
    blueprint: list[float]
    style: list[float]
    tempo: list[float]
    alpha_target: list[float]
    alpha_speed: list[float]
    alpha_curve: list[float]
    value: list[float]

class PPOUpdateMetrics(TypedDict, total=False):
    head_entropies: HeadMetrics
    head_grad_norms: HeadMetrics
```

---

## Verification

### How to Verify the Fix

- [ ] Choose Option A (document) or Option B (TypedDict)
- [ ] Update types.py accordingly
- [ ] Run mypy to verify

---

## Related Findings

None.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch4-codereview.md`
**Section:** "P3 (Code Quality)" (TYP-2)

---

## Cross-Review: PyTorch Specialist

| Verdict | ENDORSE |
|---------|---------|

**Evaluation:** Option B (HeadMetrics TypedDict) provides compile-time verification that all heads are tracked, preventing silent omissions. The value head inclusion is critical since head_grad_norms tracks it separately from HEAD_NAMES. This typing improvement has zero runtime cost.

---

## Cross-Review: DRL Specialist

| Verdict | ENDORSE |
|---------|---------|

**Evaluation:** Option B (HeadMetrics TypedDict) is preferable. Per-head entropy and gradient norms are critical PPO diagnostics for detecting policy collapse in specific action heads. Static typing ensures new heads (if added) trigger type errors, preventing silent monitoring gaps that could mask RL training pathologies.

---

## Cross-Review: Code Review Specialist

| Verdict | ENDORSE |
|---------|---------|

**Evaluation:** The generic dict typing loses type information; Option A (comment) or Option B (TypedDict) would improve API clarity and catch key typos at type-check time.
