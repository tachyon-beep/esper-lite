# Finding Ticket: torch.compile Detection Pattern is Fragile

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B10-PT-03` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 10 |
| **Agent** | `pytorch` |
| **Domain** | `tamiyo/policy` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tamiyo/policy/lstm_bundle.py` |
| **Line(s)** | `356-358` |
| **Function/Class** | `LSTMPolicyBundle.is_compiled` |

---

## Summary

**One-line summary:** Uses `hasattr(self._network, '_orig_mod')` to detect compilation - standard pattern but fragile if PyTorch internals change.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [x] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# Lines 356-358
@property
def is_compiled(self) -> bool:
    # AUTHORIZED: hasattr for torch.compile detection pattern
    return hasattr(self._network, '_orig_mod')
```

The `_orig_mod` attribute is an **internal implementation detail** of `torch.compile()`. While this is the standard detection pattern used across many codebases:

1. It's not part of the public API
2. PyTorch could change this in future versions
3. Type hint says `FactoredRecurrentActorCritic` but compiled network is `OptimizedModule`

### Impact

- **Future compatibility**: May break on PyTorch upgrade
- **Type safety**: `# type: ignore[assignment]` suppresses type errors
- **Maintenance burden**: Need to update if PyTorch changes internals

---

## Recommended Fix

Options:

1. **Add fallback check**:
```python
@property
def is_compiled(self) -> bool:
    # Primary: standard _orig_mod pattern
    if hasattr(self._network, '_orig_mod'):
        return True
    # Fallback: check module type name
    return 'OptimizedModule' in type(self._network).__name__
```

2. **Track compilation state explicitly**:
```python
def __init__(self, ...):
    self._network = ...
    self._is_compiled = False

def compile(self, mode: str = "default") -> None:
    self._network = torch.compile(self._network, mode=mode, dynamic=True)
    self._is_compiled = True

@property
def is_compiled(self) -> bool:
    return self._is_compiled
```

3. **Document the risk** (minimal):
```python
@property
def is_compiled(self) -> bool:
    # AUTHORIZED: hasattr for torch.compile detection pattern
    # NOTE: _orig_mod is an internal attribute; update if PyTorch changes this
    return hasattr(self._network, '_orig_mod')
```

---

## Verification

### How to Verify the Fix

- [ ] Add fallback detection or explicit state tracking
- [ ] Test detection works after compile
- [ ] Document PyTorch version compatibility assumptions

---

## Related Findings

- B10-PT-02: Post-compile device move (related compile handling)

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch10-drl.md`
**Section:** LB-3
