# Finding Ticket: No Enforcement Against .to(device) After Compile

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B10-PT-02` |
| **Severity** | `P1` |
| **Status** | `fixed` |
| **Batch** | 10 |
| **Agent** | `pytorch` |
| **Domain** | `tamiyo/policy` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-28 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tamiyo/policy/factory.py` |
| **Line(s)** | `98-104` |
| **Function/Class** | `create_policy()` |

---

## Summary

**One-line summary:** Warning comment says not to call `.to(device)` after compile, but there's no enforcement.

**Category:**
- [x] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [x] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
# Lines 98-104 in factory.py
# Device placement BEFORE compile - critical for trace correctness
policy.to(device)

if compile_mode is not None:
    policy.compile(mode=compile_mode)
    # WARNING: Do not call .to(device) after this point!
```

The factory correctly places device before compile. However:

1. If a caller does `policy = create_policy(...).to(other_device)`, the compiled module would be replaced/invalidated
2. The warning comment is only visible to those reading the factory source
3. No runtime enforcement prevents post-compile device moves

### Impact

- **Silent compilation invalidation**: Compiled module replaced with eager version
- **Performance regression**: User thinks they're getting compiled speedup but aren't
- **Subtle bugs**: Trace may have captured wrong device

---

## Recommended Fix

Options:

1. **Override `to()` to warn/error post-compile**:
```python
class LSTMPolicyBundle:
    def to(self, device: torch.device | str, *args, **kwargs) -> Self:
        if self.is_compiled:
            raise RuntimeError(
                "Cannot move compiled policy to new device. "
                "Create a new policy with the desired device instead."
            )
        self._network = self._network.to(device, *args, **kwargs)
        return self
```

2. **Document in class docstring** (minimal):
   - Add clear warning at class level about post-compile device moves

3. **Freeze the policy object after compile**:
   - Return a wrapper that blocks attribute modifications

---

## Verification

### How to Verify the Fix

- [x] Add override for `.to()` that checks `is_compiled`
- [x] Add overrides for `.cuda()`, `.cpu()`, `.half()`, `.float()`, `.double()`, `.bfloat16()`
- [x] Add tests that verify errors are raised on all post-compile mutations
- [x] Add tests that verify mutations work before compile
- [x] Document constraint in method docstrings

---

## Related Findings

None.

---

## Investigation Notes

**2025-12-28:** Confirmed `LSTMPolicyBundle.to()` did not guard against post-compile
device moves. Added runtime guard and a regression test.

---

## Resolution

### Final Fix Description

Added comprehensive runtime guards for all device/dtype mutation methods in `LSTMPolicyBundle`:

1. **Helper method**: `_check_not_compiled(method_name)` - centralized guard logic
2. **Device guards**: `.to()`, `.cuda()`, `.cpu()` - all raise RuntimeError when compiled
3. **Dtype guards**: `.half()`, `.float()`, `.double()`, `.bfloat16()` - all raise when compiled

This prevents silent invalidation of `torch.compile` graphs via any mutation path.

### Tests Added/Modified

- `tests/tamiyo/test_policy_bundle.py`:
  - `TestCompiledPolicyImmutability` (7 tests): Verifies all mutation methods raise after compile
  - `TestUncompiledPolicyMutability` (7 tests): Verifies all mutation methods work before compile

### Verified By

- [x] Automated tests pass (14/14)
- [x] Manual verification complete
- [x] Code review approved (pytorch-expert agent)

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch10-pytorch.md`
**Section:** P1 (factory.py:98-104)
