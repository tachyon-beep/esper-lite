# Finding Ticket: Shapley Condition Threshold Lacks Explanation

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B5-CR-09` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 5 |
| **Agent** | `codereview` |
| **Domain** | `simic/attribution` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/attribution/counterfactual_helper.py` |
| **Line(s)** | `143-144` |
| **Function/Class** | `CounterfactualHelper._process_matrix()` |

---

## Summary

**One-line summary:** Condition `len(matrix.configs) > len(slot_ids) + 1` for Shapley computation is undocumented.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The condition that determines whether to compute Shapley values:

```python
if len(matrix.configs) > len(slot_ids) + 1:
    shapley_values = self.engine.compute_shapley_values(matrix)
```

This heuristic works but the reasoning isn't documented:
- For 2 slots, full factorial = 4 configs, but `2 + 1 = 3`, so Shapley is computed
- For ablation_only with 2 slots: 4 configs (all on, each off, all off) = `2 + 2`

---

## Recommended Fix

Add a comment explaining the rationale:

```python
# Shapley values require more than ablation-only configs.
# Ablation-only produces n+2 configs (all on + n singles + all off).
# Full factorial produces 2^n configs.
# We compute Shapley when we have more than minimal (n+1) configs.
if len(matrix.configs) > len(slot_ids) + 1:
    shapley_values = self.engine.compute_shapley_values(matrix)
```

---

## Verification

### How to Verify the Fix

- [ ] Add comment explaining the threshold
- [ ] No functional change needed

---

## Related Findings

None.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch5-codereview.md`
**Section:** "P3 - Code Quality" (ID 11)

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** The threshold logic is mathematically sound but non-obvious. For Shapley value computation in RL attribution, full factorial requires 2^n configurations to properly attribute credit across all coalition subsets. The `n+1` threshold correctly identifies when only ablation configs are present (insufficient for proper Shapley). Adding this comment will help future maintainers understand the game-theoretic foundation without needing to re-derive the condition.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** Shapley values provide principled credit assignment for multi-slot policies, which is exactly what RL needs for understanding which modules contribute to returns. The `n+1` threshold distinguishes between ablation-only (which gives marginal contributions but not interaction effects) and full/partial factorial designs (which enable Shapley computation). This is a non-obvious heuristic from cooperative game theory applied to RL attribution. Documenting it prevents future maintainers from "simplifying" the condition and breaking Shapley computation for valid factorial matrices.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** The condition `len(matrix.configs) > len(slot_ids) + 1` at line 143 in counterfactual_helper.py determines whether to compute Shapley values but lacks any explanation. The threshold represents "more than ablation-only configs" - ablation produces n+2 configs (all-on, each-slot-off, all-off), while the condition checks for >n+1, meaning Shapley is computed for full factorial or sampled strategies. Adding a comment explaining this heuristic is a valid documentation improvement for maintainability.
