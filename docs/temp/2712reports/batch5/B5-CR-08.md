# Finding Ticket: EMA Delta Variable Name Could Be Clearer

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B5-CR-08` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 5 |
| **Agent** | `codereview` |
| **Domain** | `simic/control` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/control/normalization.py` |
| **Line(s)** | `92-98` |
| **Function/Class** | `RunningMeanStd.update()` |

---

## Summary

**One-line summary:** The `delta` variable is computed before mean update but used after - naming could be clearer.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The comment is excellent and explains the math, but the variable naming could be clearer:

```python
# The cross-term must be computed BEFORE updating the mean.
delta = batch_mean - self.mean
self.mean = self.momentum * self.mean + (1 - self.momentum) * batch_mean
# delta is still the OLD delta, which is correct
self.var = (
    self.momentum * self.var
    + (1 - self.momentum) * batch_var
    + self.momentum * (1 - self.momentum) * delta ** 2
)
```

The `delta` variable represents the difference using the OLD mean, but this isn't obvious from the name.

---

## Recommended Fix

Rename to `delta_old` or add inline comment clarifying this is intentional:

```python
# The cross-term must be computed BEFORE updating the mean.
delta_pre_update = batch_mean - self.mean  # Using old mean intentionally
self.mean = self.momentum * self.mean + (1 - self.momentum) * batch_mean
self.var = (
    self.momentum * self.var
    + (1 - self.momentum) * batch_var
    + self.momentum * (1 - self.momentum) * delta_pre_update ** 2
)
```

---

## Verification

### How to Verify the Fix

- [ ] Rename variable or add clarifying comment
- [ ] No functional change needed

---

## Related Findings

- B5-DRL-02: EMA variance is biased estimator (related EMA concern)

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch5-codereview.md`
**Section:** "P4 - Style/Minor" (line 92-98)

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** This is a well-known pattern in running statistics computation (Welford's algorithm variant for EMA). The `delta_pre_update` naming is clearer and matches naming conventions in reference implementations like PyTorch's BatchNorm internals. This is particularly important for torch.compile compatibility since the computation order must be preserved exactly to avoid numerical divergence between eager and compiled modes.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** This is the Welford-style parallel/EMA variance update formula. The cross-term `momentum * (1-momentum) * delta^2` requires delta to be computed with the OLD mean, which is a subtle but critical ordering dependency. In RL, observation normalization bugs are notoriously hard to debug because they manifest as gradual policy degradation rather than immediate failures. Renaming to `delta_pre_update` makes the intent explicit and prevents future refactoring mistakes that could silently corrupt variance estimates.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `NEUTRAL` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** The existing code at lines 92-105 already has an excellent comment block explaining the Law of Total Variance and explicitly states "The cross-term must be computed BEFORE updating the mean." The inline comment "delta is still the OLD delta, which is correct" mentioned in the ticket does not exist in the actual code, so the finding may be based on outdated context. Renaming to `delta_pre_update` is a marginal style improvement but the current implementation with its multi-line mathematical explanation is already sufficiently clear for this P4 issue.
