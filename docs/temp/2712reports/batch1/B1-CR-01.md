# Finding Ticket: Untyped GOVERNOR_ROLLBACK Telemetry Payload

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B1-CR-01` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 1 |
| **Agent** | `codereview` |
| **Domain** | `tolaria` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tolaria/governor.py` |
| **Line(s)** | `249-264, 300-312` |
| **Function/Class** | `TolariaGovernor.execute_rollback()` |

---

## Summary

**One-line summary:** GOVERNOR_ROLLBACK event uses untyped dict payload with `type: ignore[arg-type]` instead of typed dataclass.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The GOVERNOR_ROLLBACK telemetry event uses an untyped dictionary payload with a `type: ignore[arg-type]` comment to suppress type checking. This violates the codebase's typed telemetry migration plan.

### Code Evidence

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py:249-264

hub.emit(TelemetryEvent(
    event_type=TelemetryEventType.GOVERNOR_ROLLBACK,
    ...
    data={  # type: ignore[arg-type]
        "env_id": env_id,
        "device": str(device),
        "reason": panic_reason,
        "loss_at_panic": ...,
        "loss_threshold": ...,
        "consecutive_panics": ...,
        "panic_reason": ...,
    },
))
```

### Why This Matters

- Type safety is reduced - typos in field names won't be caught
- IDE autocompletion doesn't work for payload fields
- Downstream consumers must use string keys instead of typed attribute access
- Inconsistent with other telemetry events that have been migrated to typed payloads

---

## System Context

Per the typed telemetry migration plan (`docs/plans/2025-12-25-typed-telemetry-payloads-design.md`), all telemetry events should use typed dataclass payloads from leyline.

**Relevant architectural principles:**
- [ ] Signal-to-Noise Hypothesis (sensors match capabilities)
- [ ] Rent Economy (complexity pays rent)
- [ ] Inverted Control Flow (GPU-first)
- [ ] Governor prevents catastrophe
- [ ] No defensive programming policy
- [ ] No legacy code policy

---

## Recommended Fix

### Approach

Create `GovernorRollbackPayload` typed dataclass in leyline/telemetry.py and update both emission sites.

### Suggested Code Change

```python
# /home/john/esper-lite/src/esper/leyline/telemetry.py (new)

@dataclass(slots=True, frozen=True)
class GovernorRollbackPayload:
    """Payload for GOVERNOR_ROLLBACK telemetry events."""
    env_id: int
    device: str
    reason: str
    loss_at_panic: float | None = None
    loss_threshold: float | None = None
    consecutive_panics: int | None = None
    panic_reason: str | None = None
    missing_keys: tuple[str, ...] | None = None
    unexpected_keys: tuple[str, ...] | None = None
```

```python
# /home/john/esper-lite/src/esper/tolaria/governor.py:249-264

hub.emit(TelemetryEvent(
    event_type=TelemetryEventType.GOVERNOR_ROLLBACK,
    ...
    data=GovernorRollbackPayload(
        env_id=env_id,
        device=str(device),
        reason=panic_reason,
        loss_at_panic=...,
        loss_threshold=...,
        consecutive_panics=...,
        panic_reason=...,
    ),
))
```

---

## Verification

### How to Verify the Fix

- [ ] Unit test: Verify GovernorRollbackPayload can be constructed with all field combinations
- [ ] Integration test: Run training with governor rollback and verify telemetry is emitted correctly
- [ ] Type check: Run mypy and ensure no `type: ignore` comments remain for this payload

### Test Files to Update

- `tests/tolaria/test_governor.py` - verify telemetry emission uses new payload type

---

## Related Findings

| Ticket ID | Relationship | Notes |
|-----------|--------------|-------|
| `B1-CR-02` | `related` | Dual emission of same event type compounds this issue |

---

## Cross-Review

| Agent | Verdict | Evaluation |
|-------|---------|------------|
| **DRL** | NEUTRAL | Typed telemetry payloads are good engineering hygiene but have zero impact on RL training dynamics. The untyped dict still captures all necessary governor rollback data for post-hoc training analysis. |
| **PyTorch** | NEUTRAL | Type safety improvement for telemetry is valid Python hygiene, but has zero impact on torch.compile, tensor operations, or GPU correctness. Migrating to a typed dataclass is a good practice but irrelevant to PyTorch runtime behavior. |
| **CodeReview** | ENDORSE | The untyped dict payload with `type: ignore[arg-type]` violates the project's typed telemetry conventions. The code even has a TODO comment acknowledging this debt. Creating `GovernorRollbackPayload` in leyline aligns with the project's contracts architecture and typed payload migration plan. |

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch1-codereview.md`
**Section:** "P3-001: Telemetry payload not yet typed for GOVERNOR_ROLLBACK"
