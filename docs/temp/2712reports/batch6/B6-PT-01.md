# Finding Ticket: PBRS Warning Continues with Potentially Wrong Values

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B6-PT-01` |
| **Severity** | `P2` |
| **Status** | `open` |
| **Batch** | 6 |
| **Agent** | `pytorch` |
| **Domain** | `simic/rewards` |
| **Assignee** | |
| **Created** | 2024-12-27 |
| **Updated** | 2024-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/simic/rewards/rewards.py` |
| **Line(s)** | `1186-1193` |
| **Function/Class** | `_contribution_pbrs_bonus()` |

---

## Summary

**One-line summary:** PBRS bonus logs warning for incorrect SeedInfo construction but continues with potentially wrong values.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [x] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [x] API design / contract violation
- [ ] Test coverage gap
- [ ] Documentation / naming
- [ ] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

```python
if seed_info.epochs_in_stage == 0:
    # Just transitioned - use actual previous epoch count
    if seed_info.previous_epochs_in_stage == 0 and seed_info.previous_stage != 0:
        _logger.warning(
            "PBRS telescoping risk: transition from stage %d with previous_epochs_in_stage=0.",
            seed_info.previous_stage,
        )
    # Continues with potentially incorrect phi_prev calculation
```

When `SeedInfo` is constructed incorrectly (`previous_epochs_in_stage=0` when the seed actually spent time in the previous stage), the PBRS bonus will be computed incorrectly. The code logs a warning but continues, which:

1. Breaks PBRS telescoping property
2. Invalidates policy invariance guarantees
3. Could cause reward magnitude anomalies

---

## Recommended Fix

Consider raising an exception for clearly invalid states:

```python
if seed_info.epochs_in_stage == 0:
    if seed_info.previous_epochs_in_stage == 0 and seed_info.previous_stage != 0:
        raise ValueError(
            f"Invalid SeedInfo: transition from stage {seed_info.previous_stage} "
            f"with previous_epochs_in_stage=0. This breaks PBRS telescoping."
        )
```

Or, if continuing is desired for robustness, make the warning more severe:

```python
_logger.error(  # Upgraded from warning
    "PBRS VIOLATION: Invalid transition from stage %d - "
    "reward guarantees may be broken.",
    seed_info.previous_stage,
)
```

---

## Verification

### How to Verify the Fix

- [ ] Decide: raise exception or continue with error log
- [ ] Add validation layer for SeedInfo construction
- [ ] Add test for invalid SeedInfo detection

---

## Related Findings

- B6-DRL-02: PBRS telescoping comment misleading

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch6-pytorch.md`
**Section:** "P2-2: Potential Numerical Instability in PBRS Bonus"

---

## Cross-Review (PyTorch Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | PyTorch Specialist |
| **Date** | 2024-12-27 |

**Evaluation:** While this is pure Python code, the PBRS telescoping property directly affects reward values fed to the RL policy network. Incorrect phi values will produce reward signals with wrong magnitudes, which can destabilize training through gradient scale issues. Silent continuation with wrong values is worse than failing fast - recommend raising ValueError for clearly invalid states to prevent corrupted training runs that waste GPU compute.

---

## Cross-Review (DRL Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | DRL Specialist |

**Evaluation:** This is a critical correctness issue. PBRS (Ng et al., 1999) requires the telescoping property: F(s,a,s') = gamma * phi(s') - phi(s). If `previous_epochs_in_stage=0` when the seed actually spent time in the prior stage, phi_prev is computed incorrectly, breaking the telescoping sum and invalidating the policy invariance guarantee. Continuing with wrong values corrupts the reward signal silently. Strongly recommend failing fast with an exception rather than logging and continuing with broken guarantees.

---

## Cross-Review (Code Review Specialist)

| Field | Value |
|-------|-------|
| **Verdict** | `ENDORSE` |
| **Reviewer** | Code Review Specialist |

**Evaluation:** This is a legitimate P2 concern. PBRS (Potential-Based Reward Shaping) has a mathematical invariant (telescoping) that breaks when `previous_epochs_in_stage=0` for a non-DORMANT transition. Continuing with a warning violates the Defensive Programming Prohibition: if this state is invalid, the code should fail fast rather than produce silently wrong rewards. The recommended fix to raise `ValueError` aligns with project policy.
