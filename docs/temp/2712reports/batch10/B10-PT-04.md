# Finding Ticket: assert Statements Can Be Disabled by -O Flag

---

## Ticket Metadata

| Field | Value |
|-------|-------|
| **Ticket ID** | `B10-PT-04` |
| **Severity** | `P3` |
| **Status** | `open` |
| **Batch** | 10 |
| **Agent** | `pytorch` |
| **Domain** | `tamiyo/policy` |
| **Assignee** | |
| **Created** | 2025-12-27 |
| **Updated** | 2025-12-27 |

---

## Location

| Field | Value |
|-------|-------|
| **File(s)** | `/home/john/esper-lite/src/esper/tamiyo/policy/features.py` |
| **Line(s)** | (various - `_DEBUG_STAGE_VALIDATION`) |
| **Function/Class** | Stage validation assertions |

---

## Summary

**One-line summary:** Debug assertions use `assert` which can be disabled by Python's `-O` optimization flag.

**Category:**
- [ ] Correctness bug
- [ ] Race condition / concurrency
- [ ] Memory leak / resource issue
- [ ] Performance bottleneck
- [ ] Numerical stability
- [ ] torch.compile compatibility
- [ ] Dead code / unwired functionality
- [ ] API design / contract violation
- [ ] Test coverage gap
- [x] Documentation / naming
- [x] Defensive programming violation
- [ ] Legacy code policy violation

---

## Detailed Description

### What's Wrong

The `_DEBUG_STAGE_VALIDATION` flag controls assertions that validate stage encoding:

```python
_DEBUG_STAGE_VALIDATION = False  # Set True to enable stage validation

# Usage (various places):
if _DEBUG_STAGE_VALIDATION:
    assert stage in _STAGE_TO_INDEX, f"Unknown stage: {stage}"
```

While the debug flag makes these opt-in, the use of `assert` means:
1. If someone enables `_DEBUG_STAGE_VALIDATION = True`
2. But runs with `python -O` (optimized mode)
3. The assertions silently disappear

### Impact

- **Low severity**: Debug-only code path
- **Edge case**: Only affects users who enable debug AND use -O flag
- **Correctness**: Could miss validation when user expects it

---

## Recommended Fix

Use explicit if/raise for validation-critical checks:

```python
if _DEBUG_STAGE_VALIDATION:
    if stage not in _STAGE_TO_INDEX:
        raise ValueError(f"Unknown stage: {stage}")
```

This ensures validation always runs when enabled, regardless of -O flag.

---

## Verification

### How to Verify the Fix

- [ ] Replace assert with explicit if/raise in debug validation
- [ ] Document that -O does not affect debug validation
- [ ] Test that validation works with -O flag

---

## Related Findings

None.

---

## Appendix

### Original Report Reference

**Report file:** `docs/temp/2712reports/batch10-drl.md`
**Section:** FE-4
