# Nissa - Internals

## Document Metadata

| Field | Value |
|-------|-------|
| **Parent Document** | [10-nissa-unified-design.md](10-nissa-unified-design.md) |
| **Component Type** | Internals |
| **Version** | 3.0 |
| **Status** | PRODUCTION |
| **Implementation** | Complete |

## Overview

This document provides a detailed look into the internal implementation of Nissa, the observability platform. It covers the SLO framework, circuit breaker implementation, memory management, Protocol Buffers v2 integration, conservative mode, and other C-016 critical fixes.

## SLO Framework with Error Budgets

Nissa includes a comprehensive SLO framework for tracking and enforcing service level objectives. The framework has the following features:

- **SLO definitions with error budgets**: For key performance indicators.
- **Error budget burn rate thresholds**: For alerting on rapid budget consumption.
- **Automatic conservative mode triggers**: Based on SLO violations.

```python
class NissaSLOFramework:
    """[R6-FIX] Comprehensive SLO tracking for observability platform"""
    
    def __init__(self):
        # Primary SLOs
        self.slos = {
            "event_ingestion_latency": SLODefinition(
                name="event_ingestion_latency",
                target_percentage=99.9,
                measurement_window_ms=2_592_000_000,  # 30 days
                error_budget_burn_rate_threshold=10.0
            ),
            # ... more SLOs
        }
```

## Circuit Breaker Implementation

All `assert` statements in Nissa have been replaced with circuit breakers to ensure graceful degradation in case of failures. The circuit breaker implementation has the following features:

- **Three states**: `CLOSED`, `OPEN`, and `HALF-OPEN`.
- **Conservative mode**: Triggers a conservative mode instead of crashing the system.
- **Violation metrics**: Emits metrics for monitoring and alerting.

```python
class ObservabilityCircuitBreaker:
    """[R6-FIX] Circuit breaker to replace assert statements in observability"""
    
    def __init__(self, config: CircuitBreakerConfig, component_name: str):
        self.config = config
        self.component_name = component_name
        self.state = CircuitBreakerState.CLOSED
        self.failure_count = 0
        self.last_failure_time_ms = 0
        self.half_open_calls = 0
        self.total_calls = 0
        self.successful_calls = 0
```

## Memory Management with TTL Cleanup

Nissa uses a TTL-based memory management system to prevent unbounded growth in caches. This system has the following features:

- **TTL-based cleanup**: For all caches.
- **Composite keying**: `(epoch, request_id)` to prevent collisions.
- **Periodic garbage collection**: To prevent memory leaks.

```python
class MemoryManager:
    """[R6-FIX] Prevent memory leaks with TTL-based cleanup"""
    
    def __init__(self):
        # TTL-based storage with (epoch, request_id) composite keys
        self.event_cache: Dict[Tuple[int, str], Dict] = {}
        self.metric_cache: Dict[Tuple[int, str], Dict] = {}
        self.alert_cache: Dict[Tuple[int, str], Dict] = {}
```

## Protocol Buffers v2 Integration

Nissa uses Protocol Buffers v2 for all telemetry messages. This provides the following benefits:

- **No `map<>` fields**: For improved performance and compatibility.
- **Decode-reencode validation**: To ensure message integrity.
- **Containerized toolchain**: To eliminate drift and build failures.

```python
class ProtocolBufferV2Handler:
    """[R6-FIX] Protocol Buffers v2 message handling with validation"""
    
    def __init__(self):
        # Message type registry
        self.message_types = {
            "telemetry_event": TelemetryEventProto,
            "metric_point": MetricPointProto,
            "alert_notification": AlertNotificationProto,
            "control_command": ControlCommandProto
        }
```

## Conservative Mode Implementation

Nissa uses a conservative mode and backpressure mechanism to handle high load and prevent system failures. This includes:

- **Conservative mode policies**: To reduce resource utilization under load.
- **Queue depth limits**: To prevent message queues from growing indefinitely.
- **Priority-based backpressure**: To ensure that high-priority messages are not dropped.

```python
class ConservativeModeManager:
    """[R6-FIX] Conservative mode with backpressure handling"""
    
    def __init__(self):
        self.current_mode = ConservativeMode.NORMAL
        self.mode_transition_time_ms = 0
```

## References

- Parent: [10-nissa-unified-design.md](10-nissa-unified-design.md)

---

*Component Owner: System Architecture Team | Last Updated: 2025-09-10*
