<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karn · Morphogenetic Training Observatory</title>

    <!-- Fonts: Oxanium for headers (geometric, technical), JetBrains Mono for data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Oxanium:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Deep observatory background */
            --bg-void: #05080f;
            --bg-primary: #0a1020;
            --bg-panel: #0d1528;
            --bg-elevated: #121d35;

            /* Bioluminescent accents */
            --glow-cyan: #00e5ff;
            --glow-cyan-dim: rgba(0, 229, 255, 0.15);
            --glow-cyan-bright: rgba(0, 229, 255, 0.4);

            /* Status colors */
            --status-win: #00ff9d;
            --status-win-glow: rgba(0, 255, 157, 0.3);
            --status-loss: #ff5c5c;
            --status-loss-glow: rgba(255, 92, 92, 0.3);
            --status-warn: #ffb347;
            --status-warn-glow: rgba(255, 179, 71, 0.3);
            --status-neutral: #6b7c9e;

            /* Text hierarchy */
            --text-bright: #f0f6ff;
            --text-primary: #c8d4e8;
            --text-secondary: #6b7c9e;
            --text-dim: #3d4a66;

            /* Borders */
            --border-subtle: rgba(100, 130, 180, 0.15);
            --border-glow: rgba(0, 229, 255, 0.3);

            /* Typography */
            --font-display: 'Oxanium', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;

            /* Subtle grid texture */
            background-image:
                linear-gradient(var(--bg-primary) 1px, transparent 1px),
                linear-gradient(90deg, var(--bg-primary) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center center;
        }

        /* Main container */
        .observatory {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--space-lg);
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: var(--space-lg);
        }

        .header__title {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--glow-cyan);
            text-shadow: 0 0 20px var(--glow-cyan-dim);
        }

        .header__subtitle {
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
            margin-top: 2px;
        }

        .header__status {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .epoch-display {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .epoch-display__current {
            color: var(--text-bright);
            font-weight: 600;
        }

        .mode-badge {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 2px;
            background: var(--glow-cyan-dim);
            color: var(--glow-cyan);
            border: 1px solid var(--border-glow);
        }

        /* Headline metrics - the stars of the show */
        .headlines {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .headline-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .headline-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--status-neutral);
            transition: all 0.3s ease;
        }

        .headline-card.win::before {
            background: var(--status-win);
            box-shadow: 0 0 20px var(--status-win-glow);
        }

        .headline-card.loss::before {
            background: var(--status-loss);
            box-shadow: 0 0 20px var(--status-loss-glow);
        }

        .headline-card__label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .headline-card__value {
            font-family: var(--font-display);
            font-size: 42px;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1;
            transition: all 0.3s ease;
        }

        .headline-card.win .headline-card__value {
            color: var(--status-win);
            text-shadow: 0 0 30px var(--status-win-glow);
        }

        .headline-card.loss .headline-card__value {
            color: var(--status-loss);
            text-shadow: 0 0 30px var(--status-loss-glow);
        }

        .headline-card__delta {
            font-size: 14px;
            font-weight: 500;
            margin-top: var(--space-sm);
            color: var(--text-secondary);
        }

        .headline-card__delta.positive {
            color: var(--status-win);
        }

        .headline-card__delta.negative {
            color: var(--status-loss);
        }

        .headline-card__indicator {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 2px;
            opacity: 0;
            transform: translateY(-4px);
            transition: all 0.3s ease;
        }

        .headline-card.win .headline-card__indicator {
            opacity: 1;
            transform: translateY(0);
            background: var(--status-win);
            color: var(--bg-void);
        }

        .headline-card.loss .headline-card__indicator {
            opacity: 1;
            transform: translateY(0);
            background: var(--status-loss);
            color: var(--bg-void);
        }

        /* Panel grid */
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            overflow: hidden;
        }

        .panel--full {
            grid-column: 1 / -1;
        }

        .panel__header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel__title {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .panel__body {
            padding: var(--space-md);
        }

        /* Seed contributions */
        .seed-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .seed-item {
            display: grid;
            grid-template-columns: 70px 1fr auto;
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .seed-item:last-child {
            border-bottom: none;
        }

        .seed-item__name {
            font-weight: 600;
            color: var(--glow-cyan);
            font-size: 12px;
        }

        .seed-item__details {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .seed-item__blueprint {
            color: var(--text-dim);
        }

        .seed-item__contribution {
            font-weight: 600;
            font-size: 13px;
        }

        .seed-item__contribution.positive {
            color: var(--status-win);
        }

        .seed-item__contribution.negative {
            color: var(--status-loss);
        }

        .seed-item__efficiency {
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .seed-item__efficiency.star {
            color: var(--status-warn);
        }

        .seed-item__efficiency.star::after {
            content: '★';
        }

        /* Progress bar for seed contribution visualization */
        .seed-item__bar {
            height: 3px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .seed-item__bar-fill {
            height: 100%;
            background: var(--glow-cyan);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Metric rows */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row__label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .metric-row__value {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-bright);
        }

        .metric-row__value.healthy {
            color: var(--status-win);
        }

        .metric-row__value.warning {
            color: var(--status-warn);
        }

        .metric-row__value.danger {
            color: var(--status-loss);
        }

        /* Action chips for recent actions */
        .action-stream {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .action-chip {
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 2px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }

        .action-chip.wait {
            opacity: 0.5;
        }

        .action-chip.germinate {
            background: rgba(0, 255, 157, 0.1);
            border-color: var(--status-win);
            color: var(--status-win);
        }

        .action-chip.fossilize {
            background: var(--glow-cyan-dim);
            border-color: var(--glow-cyan);
            color: var(--glow-cyan);
        }

        .action-chip.prune {
            background: rgba(255, 92, 92, 0.1);
            border-color: var(--status-loss);
            color: var(--status-loss);
        }

        .action-chip.new {
            animation: chip-pulse 0.5s ease;
        }

        @keyframes chip-pulse {
            0% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Alerts panel */
        .alerts {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .alerts.has-alerts {
            color: var(--status-loss);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) 0;
        }

        .alert-item::before {
            content: '⚠';
            color: var(--status-warn);
        }

        .alert-item.critical::before {
            content: '●';
            color: var(--status-loss);
            animation: alert-pulse 1s ease infinite;
        }

        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .connection-status__dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: all 0.3s ease;
        }

        .connection-status.connected .connection-status__dot {
            background: var(--status-win);
            box-shadow: 0 0 8px var(--status-win-glow);
            animation: dot-pulse 2s ease infinite;
        }

        .connection-status.disconnected .connection-status__dot {
            background: var(--status-loss);
        }

        .connection-status.connecting .connection-status__dot {
            background: var(--status-warn);
            animation: dot-pulse 0.5s ease infinite;
        }

        @keyframes dot-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: var(--space-lg);
            color: var(--text-dim);
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .headlines {
                grid-template-columns: 1fr;
            }

            .panels {
                grid-template-columns: 1fr;
            }

            .headline-card__value {
                font-size: 32px;
            }
        }

        /* Subtle scan line effect for that observatory feel */
        .observatory::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="observatory">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header__title">Karn</h1>
                <p class="header__subtitle">Morphogenetic Training Observatory</p>
            </div>
            <div class="header__status">
                <span class="mode-badge" id="mode">SHAPED</span>
                <span class="epoch-display">
                    Epoch <span class="epoch-display__current" id="epoch-current">--</span> / <span id="epoch-total">--</span>
                </span>
            </div>
        </header>

        <!-- Headline metrics -->
        <div class="headlines">
            <div class="headline-card" id="accuracy-card">
                <span class="headline-card__indicator">WIN</span>
                <div class="headline-card__label">Accuracy</div>
                <div class="headline-card__value" id="accuracy-value">--.-<span style="font-size: 24px;">%</span></div>
                <div class="headline-card__delta" id="accuracy-delta">-- vs host-only</div>
            </div>

            <div class="headline-card" id="efficiency-card">
                <span class="headline-card__indicator">WIN</span>
                <div class="headline-card__label">Parameter Efficiency</div>
                <div class="headline-card__value" id="efficiency-value">--.-<span style="font-size: 24px;">x</span></div>
                <div class="headline-card__delta" id="efficiency-delta">-- params vs host</div>
            </div>
        </div>

        <!-- Main panels -->
        <div class="panels">
            <!-- Seed contributions -->
            <div class="panel panel--full">
                <div class="panel__header">
                    <span class="panel__title">Seed Contributions</span>
                    <span class="panel__title" style="color: var(--text-dim);">Shapley Attribution</span>
                </div>
                <div class="panel__body">
                    <div class="seed-list" id="seed-list">
                        <div class="empty-state">No active seeds</div>
                    </div>
                </div>
            </div>

            <!-- Policy health -->
            <div class="panel">
                <div class="panel__header">
                    <span class="panel__title">Policy Health</span>
                </div>
                <div class="panel__body">
                    <div class="metric-row">
                        <span class="metric-row__label">Value Variance</span>
                        <span class="metric-row__value" id="value-variance">-- <span style="color: var(--text-dim);">(--)</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row__label">Entropy</span>
                        <span class="metric-row__value" id="entropy">-- <span style="color: var(--text-dim);">(--)</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row__label">KL Divergence</span>
                        <span class="metric-row__value" id="kl-div">-- <span style="color: var(--text-dim);">(--)</span></span>
                    </div>
                </div>
            </div>

            <!-- Recent actions -->
            <div class="panel">
                <div class="panel__header">
                    <span class="panel__title">Recent Actions</span>
                </div>
                <div class="panel__body">
                    <div class="action-stream" id="action-stream">
                        <span class="action-chip wait">WAIT</span>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="panel panel--full">
                <div class="panel__header">
                    <span class="panel__title">Alerts</span>
                </div>
                <div class="panel__body">
                    <div class="alerts" id="alerts">
                        <span style="color: var(--status-win);">● </span>No active alerts
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection status -->
    <div class="connection-status disconnected" id="connection-status">
        <span class="connection-status__dot"></span>
        <span id="connection-text">Disconnected</span>
    </div>

    <script>
        // ============================================================
        // Karn Dashboard - WebSocket Client
        // ============================================================

        // State
        const state = {
            epoch: 0,
            maxEpochs: 100,
            mode: 'SHAPED',
            accuracy: 0,
            hostAccuracy: 0,
            paramRatio: 1.0,
            efficiency: 1.0,
            seeds: [],
            valueVariance: 0,
            entropy: 0,
            klDivergence: 0,
            recentActions: [],
            alerts: [],
        };

        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function connect() {
            const wsUrl = `ws://${window.location.host}/ws`;
            updateConnectionStatus('connecting');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[Karn] Connected to telemetry stream');
                reconnectAttempts = 0;
                updateConnectionStatus('connected');
            };

            ws.onclose = () => {
                console.log('[Karn] Disconnected from telemetry stream');
                updateConnectionStatus('disconnected');

                // Exponential backoff reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    reconnectAttempts++;
                    console.log(`[Karn] Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                    setTimeout(connect, delay);
                }
            };

            ws.onerror = (error) => {
                console.error('[Karn] WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleEvent(data);
                } catch (e) {
                    console.error('[Karn] Failed to parse event:', e);
                }
            };
        }

        function handleEvent(event) {
            switch (event.event_type) {
                case 'EPOCH_COMPLETED':
                    state.epoch = event.epoch ?? event.data?.epoch ?? state.epoch;
                    state.accuracy = event.data?.val_accuracy ?? state.accuracy;
                    state.hostAccuracy = event.data?.host_accuracy ?? state.hostAccuracy;
                    break;

                case 'ANALYTICS_SNAPSHOT':
                    // Full state update from Karn analytics
                    if (event.data) {
                        state.accuracy = event.data.accuracy ?? state.accuracy;
                        state.hostAccuracy = event.data.host_accuracy ?? state.hostAccuracy;
                        state.paramRatio = event.data.param_ratio ?? state.paramRatio;
                        state.efficiency = event.data.efficiency ?? state.efficiency;
                        state.seeds = event.data.seeds ?? state.seeds;
                        state.valueVariance = event.data.value_variance ?? state.valueVariance;
                        state.entropy = event.data.entropy ?? state.entropy;
                        state.klDivergence = event.data.kl_divergence ?? state.klDivergence;
                    }
                    break;

                case 'SEED_GERMINATED':
                    addAction('GERMINATE', event.data?.slot_id);
                    break;

                case 'SEED_FOSSILIZED':
                    addAction('FOSSILIZE', event.data?.slot_id);
                    break;

                case 'SEED_PRUNED':
                    addAction('PRUNE', event.data?.slot_id);
                    break;

                case 'POLICY_ACTION':
                    if (event.data?.action === 'WAIT') {
                        addAction('WAIT');
                    }
                    break;

                case 'PPO_UPDATE_COMPLETED':
                    state.valueVariance = event.data?.value_variance ?? state.valueVariance;
                    state.entropy = event.data?.entropy ?? state.entropy;
                    state.klDivergence = event.data?.kl_divergence ?? state.klDivergence;
                    break;

                case 'ANOMALY_DETECTED':
                case 'GOVERNOR_ROLLBACK':
                    addAlert(event.data?.message ?? event.event_type, event.event_type === 'GOVERNOR_ROLLBACK');
                    break;

                case 'connected':
                    console.log('[Karn] Server:', event.message);
                    break;

                case 'ping':
                    // Keep-alive, ignore
                    break;

                default:
                    console.debug('[Karn] Unhandled event:', event.event_type);
            }

            render();
        }

        function addAction(type, slot = null) {
            const action = slot ? `${type}(${slot})` : type;
            state.recentActions.push({ type, action, timestamp: Date.now() });
            if (state.recentActions.length > 8) {
                state.recentActions.shift();
            }
        }

        function addAlert(message, critical = false) {
            state.alerts.push({ message, critical, timestamp: Date.now() });
            // Keep only recent alerts (last 5 minutes)
            const cutoff = Date.now() - 5 * 60 * 1000;
            state.alerts = state.alerts.filter(a => a.timestamp > cutoff);
        }

        function render() {
            // Epoch
            document.getElementById('epoch-current').textContent = state.epoch;
            document.getElementById('epoch-total').textContent = state.maxEpochs;
            document.getElementById('mode').textContent = state.mode;

            // Accuracy
            const accDelta = state.accuracy - state.hostAccuracy;
            const accCard = document.getElementById('accuracy-card');
            const accValue = document.getElementById('accuracy-value');
            const accDeltaEl = document.getElementById('accuracy-delta');

            accValue.innerHTML = `${state.accuracy.toFixed(1)}<span style="font-size: 24px;">%</span>`;
            accDeltaEl.textContent = `${accDelta >= 0 ? '+' : ''}${accDelta.toFixed(1)}% vs host-only`;
            accDeltaEl.className = `headline-card__delta ${accDelta > 0 ? 'positive' : accDelta < 0 ? 'negative' : ''}`;
            accCard.className = `headline-card ${accDelta > 0 ? 'win' : accDelta < 0 ? 'loss' : ''}`;
            accCard.querySelector('.headline-card__indicator').textContent = accDelta > 0 ? 'WIN' : 'LOSS';

            // Efficiency
            const effCard = document.getElementById('efficiency-card');
            const effValue = document.getElementById('efficiency-value');
            const effDelta = document.getElementById('efficiency-delta');

            effValue.innerHTML = `${state.efficiency.toFixed(2)}<span style="font-size: 24px;">x</span>`;
            effDelta.textContent = `${state.paramRatio.toFixed(2)}x params vs host`;
            effDelta.className = `headline-card__delta ${state.efficiency > 1 ? 'positive' : state.efficiency < 1 ? 'negative' : ''}`;
            effCard.className = `headline-card ${state.efficiency > 1 ? 'win' : state.efficiency < 1 ? 'loss' : ''}`;
            effCard.querySelector('.headline-card__indicator').textContent = state.efficiency > 1 ? 'WIN' : 'LOSS';

            // Seeds
            renderSeeds();

            // Policy health
            renderPolicyHealth();

            // Recent actions
            renderActions();

            // Alerts
            renderAlerts();
        }

        function renderSeeds() {
            const container = document.getElementById('seed-list');

            if (!state.seeds || state.seeds.length === 0) {
                container.innerHTML = '<div class="empty-state">No active seeds</div>';
                return;
            }

            // Find max contribution for bar scaling
            const maxContrib = Math.max(...state.seeds.map(s => Math.abs(s.contribution || 0)), 1);

            container.innerHTML = state.seeds.map(seed => {
                const contrib = seed.contribution || 0;
                const isPositive = contrib >= 0;
                const efficiency = seed.efficiency || 0;
                const isStar = efficiency > 10;
                const barWidth = (Math.abs(contrib) / maxContrib) * 100;

                return `
                    <div class="seed-item">
                        <span class="seed-item__name">${seed.slot_id || 'unknown'}</span>
                        <div>
                            <span class="seed-item__details">
                                <span class="seed-item__blueprint">${seed.blueprint || '--'}</span> ·
                                ${formatParams(seed.params || 0)}
                            </span>
                            <div class="seed-item__bar">
                                <div class="seed-item__bar-fill" style="width: ${barWidth}%; background: ${isPositive ? 'var(--status-win)' : 'var(--status-loss)'}"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="seed-item__contribution ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${contrib.toFixed(1)}%</span>
                            <div class="seed-item__efficiency ${isStar ? 'star' : ''}">${efficiency.toFixed(1)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPolicyHealth() {
            // Value variance
            const vvEl = document.getElementById('value-variance');
            const vvHealth = state.valueVariance > 0.1 ? 'healthy' : state.valueVariance > 0.01 ? '' : 'warning';
            const vvLabel = state.valueVariance > 0.1 ? 'healthy' : state.valueVariance > 0.01 ? 'ok' : 'low';
            vvEl.innerHTML = `<span class="${vvHealth}">${state.valueVariance.toFixed(3)}</span> <span style="color: var(--text-dim);">(${vvLabel})</span>`;

            // Entropy
            const entEl = document.getElementById('entropy');
            const entHealth = state.entropy > 0.5 ? 'healthy' : state.entropy > 0.1 ? '' : 'warning';
            const entLabel = state.entropy > 0.5 ? 'exploring' : state.entropy > 0.1 ? 'moderate' : 'collapsed';
            entEl.innerHTML = `<span class="${entHealth}">${state.entropy.toFixed(3)}</span> <span style="color: var(--text-dim);">(${entLabel})</span>`;

            // KL divergence
            const klEl = document.getElementById('kl-div');
            const klHealth = state.klDivergence < 0.02 ? 'healthy' : state.klDivergence < 0.1 ? '' : 'warning';
            const klLabel = state.klDivergence < 0.02 ? 'stable' : state.klDivergence < 0.1 ? 'ok' : 'high';
            klEl.innerHTML = `<span class="${klHealth}">${state.klDivergence.toFixed(4)}</span> <span style="color: var(--text-dim);">(${klLabel})</span>`;
        }

        function renderActions() {
            const container = document.getElementById('action-stream');

            if (state.recentActions.length === 0) {
                container.innerHTML = '<span class="action-chip wait">WAIT</span>';
                return;
            }

            container.innerHTML = state.recentActions.map((a, i) => {
                const isNew = i === state.recentActions.length - 1;
                const chipClass = a.type.toLowerCase();
                return `<span class="action-chip ${chipClass} ${isNew ? 'new' : ''}">${a.action}</span>`;
            }).join('');
        }

        function renderAlerts() {
            const container = document.getElementById('alerts');

            if (state.alerts.length === 0) {
                container.innerHTML = '<span style="color: var(--status-win);">● </span>No active alerts';
                container.className = 'alerts';
                return;
            }

            container.className = 'alerts has-alerts';
            container.innerHTML = state.alerts.map(a => `
                <div class="alert-item ${a.critical ? 'critical' : ''}">${a.message}</div>
            `).join('');
        }

        function formatParams(n) {
            if (n >= 1e6) return `${(n / 1e6).toFixed(1)}M`;
            if (n >= 1e3) return `${(n / 1e3).toFixed(1)}K`;
            return n.toString();
        }

        function updateConnectionStatus(status) {
            const container = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');

            container.className = `connection-status ${status}`;
            text.textContent = status === 'connected' ? 'Connected' :
                              status === 'connecting' ? 'Connecting...' : 'Disconnected';
        }

        // Initialize
        render();
        connect();
    </script>
</body>
</html>
